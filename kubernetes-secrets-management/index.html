<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel="icon" href="/assets/images/logo.png"><title>Shhhh... Kubernetes Secrets Are Not Really Secret! | Technorage</title><meta name="generator" content="Jekyll v4.1.1"><meta property="og:title" content="Shhhh… Kubernetes Secrets Are Not Really Secret!"><meta name="author" content="deepu"><meta property="og:locale" content="en_US"><meta name="description" content="Learn how to setup secure secrets on Kubernetes using Sealed Secrets, External Secrets Operator, and Secrets Store CSI driver."><meta property="og:description" content="Learn how to setup secure secrets on Kubernetes using Sealed Secrets, External Secrets Operator, and Secrets Store CSI driver."><link rel="canonical" href="https://auth0.com/blog/kubernetes-secrets-management/"><meta property="og:url" content="https://auth0.com/blog/kubernetes-secrets-management/"><meta property="og:site_name" content="Technorage"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-12-15T00:00:00+01:00"><meta name="twitter:card" content="summary"><meta property="twitter:title" content="Shhhh… Kubernetes Secrets Are Not Really Secret!"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"deepu"},"dateModified":"2022-12-15T00:00:00+01:00","datePublished":"2022-12-15T00:00:00+01:00","description":"Learn how to setup secure secrets on Kubernetes using Sealed Secrets, External Secrets Operator, and Secrets Store CSI driver.","headline":"Shhhh… Kubernetes Secrets Are Not Really Secret!","mainEntityOfPage":{"@type":"WebPage","@id":"https://auth0.com/blog/kubernetes-secrets-management/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://deepu.tech/assets/images/logo.png"},"name":"deepu"},"url":"https://auth0.com/blog/kubernetes-secrets-management/"}</script><link rel="canonical" href="https://auth0.com/blog/kubernetes-secrets-management/"><meta property="og:url" content=""><meta name="monetization" content="$ilp.uphold.com/Aw7eGpxKNyK7"><meta name="twitter:site" content="@deepu105"><meta name="twitter:creator" content="@deepu105"><meta name="twitter:title" content="Shhhh... Kubernetes Secrets Are Not Really Secret!"><meta name="twitter:description" content="Learn how to setup secure secrets on Kubernetes using Sealed Secrets, External Secrets Operator, and Secrets Store CSI driver."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://images.ctfassets.net/23aumh6u8s0i/5sGRuNiW4fSPVSoZjbwkK0/f505f0bdf239fd84fc6b4d128a48d4ed/Deepu_a_container_ship_entering_a_door_lock_lens_flare_photorea_66931d74-fd55-456a-93e0-48e0ad9e927b.png"><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha256-L/W5Wfqfa0sdBNIKN9cG6QA5F2qx4qICmU2VgLruv9Y=" crossorigin="anonymous" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha256-L/W5Wfqfa0sdBNIKN9cG6QA5F2qx4qICmU2VgLruv9Y=" crossorigin="anonymous"></noscript><link href="/assets/css/screen.css" rel="stylesheet"><link href="/assets/css/main.css" rel="stylesheet"></head><body class="layout-post"><noscript id="deferred-styles"><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" crossorigin="anonymous"></noscript><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down pr-md-0 pl-md-0"><div class="container d-flex align-items-center"><a class="navbar-brand" href="/"><h2 class="sitetitle">Technorage</h2><small class="sitetitlesub">Where I rage about technology and stuff! </small></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarMediumish"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" href="/">About</a></li><li class="nav-item active"><a class="nav-link" href="/blogs/"><i class="fas fa-blog"></i> Blog</a></li><li class="nav-item"><a class="nav-link" href="/books"><i class="fas fa-book"></i> Books</a></li><li class="nav-item"><a class="nav-link" href="/appearances"><i class="fas fa-chalkboard-teacher"></i> Appearances</a></li><style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:focus,.lunrsearchresult a:hover{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style><form class="bd-search" onsubmit='return lunr_search(document.getElementById("lunrsearch").value)'><input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."></form><div id="lunrsearchresults"><ul></ul></div></ul></div></div></nav><div class="site-content"><div class="container"><div class="main-content"><div class="container mt-5"><div class="row"><div class="col-lg-2 pl-0"><div class="sticky-top sticky-top-offset"><div class="popover-wrapper d-none d-lg-block"><a href="#"><h2 class="popover-title"><i class="fas fa-stream fa-lg"></i> TOC</h2></a><div class="popover-content"><div class="toc lead"><h3 class="font-weight-bold">Summary</h3><ul><li><a href="#sealed-secrets">Sealed Secrets</a><ul><li><a href="#advantages">Advantages</a></li><li><a href="#disadvantages">Disadvantages</a></li><li><a href="#installation">Installation</a></li><li><a href="#usage">Usage</a></li></ul></li><li><a href="#external-secrets-operator">External Secrets Operator</a><ul><li><a href="#advantages-1">Advantages</a></li><li><a href="#disadvantages-1">Disadvantages</a></li><li><a href="#installation-1">Installation</a></li><li><a href="#using-hashicorp-vault">Using HashiCorp Vault</a></li><li><a href="#other-secret-managers">Other secret managers</a></li></ul></li><li><a href="#secrets-store-csi-driver">Secrets Store CSI Driver</a><ul><li><a href="#advantages-2">Advantages</a></li><li><a href="#disadvantages-2">Disadvantages</a></li><li><a href="#using-google-secret-manager-provider">Using Google Secret Manager provider</a></li><li><a href="#other-secret-managers-1">Other secret managers</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li></ul></div></div></div><div class="share"><p>Share</p><ul><li class="ml-1 mr-1"><div class="mast-share mast-share-sm"><input type="checkbox" class="mast-check-toggle"><div class="mast-instance"><span>Instance: </span><input type="textbox" name="mast-instance-input" placeholder="mastodon.social"> <button class="mast-share-button">Share</button></div><label title="Mastodon" class="mast-top mast-check-label"><i class="fab fa-mastodon"></i></label></div><script>Array.prototype.forEach || (Array.prototype.forEach = function (r) { var o, t; if (null == this) throw new TypeError("this is null or not defined"); var n = Object(this), e = n.length >>> 0; if ("function" != typeof r) throw new TypeError(r + " is not a function"); for (arguments.length > 1 && (o = arguments[1]), t = 0; t < e;) { var i; t in n && (i = n[t], r.call(o, i, t, n)), t++ } }); document.addEventListener("DOMContentLoaded", function () { document.querySelectorAll(".mast-share").forEach(function (e, t) { e.querySelector(".mast-check-toggle").id = "mast-check-toggle-" + t, e.querySelector(".mast-check-label").htmlFor = "mast-check-toggle-" + t, e.querySelector(".mast-share-button").addEventListener("click", function (t) { var a = new RegExp("^(?:(?:https?|ftp)://)?(?:\\S+(?::\\S*)?@|\\d{1,3}(?:\\.\\d{1,3}){3}|(?:(?:[a-z\\d\\u00a1-\\uffff]+-?)*[a-z\\d\\u00a1-\\uffff]+)(?:\\.(?:[a-z\\d\\u00a1-\\uffff]+-?)*[a-z\\d\\u00a1-\\uffff]+)*(?:\\.[a-z\\u00a1-\\uffff]{2,6}))(?::\\d+)?(?:[^\\s]*)?$", "i"), n = e.querySelector('input[name="mast-instance-input"]'); if (a.test(n.value)) { var o = `http://${n.value.replace(/(^\w+:|^)\/\//, "")}/share?text=${encodeURIComponent(document.title)} ${encodeURIComponent(location.href)}`; window.open(o, "new", "toolbar=no,location=no,status=yes,resizable=yes,scrollbars=yes,height=600,width=400") } else n.classList.add("invalid"), setTimeout(function () { n.classList.remove("invalid") }, 300) }), e.addEventListener("mouseleave", function (t) { e.querySelector(".mast-check-toggle").checked = !1 }) }) });</script></li><li class="ml-1 mr-1"><a target="_blank" href="https://twitter.com/intent/tweet?text=Shhhh... Kubernetes Secrets Are Not Really Secret! by @deepu105 &url=https://deepu.tech/kubernetes-secrets-management/" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1' title="Twitter"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://deepu.tech/kubernetes-secrets-management/" onclick='return window.open(this.href,"linkedin-share","width=550,height=435"),!1' title="Linkedin"><i class="fab fa-linkedin-in"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://news.ycombinator.com/submitlink?u=https://deepu.tech/kubernetes-secrets-management/&t=Shhhh... Kubernetes Secrets Are Not Really Secret!" onclick='return window.open(this.href,"hackernews-share","width=550,height=435"),!1' title="Hacker News"><i class="fab fa-hacker-news-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.reddit.com/submit?url=https://deepu.tech/kubernetes-secrets-management/&title=Shhhh... Kubernetes Secrets Are Not Really Secret!" onclick='return window.open(this.href,"reddit-share","width=550,height=435"),!1' title="Reddit"><i class="fab fa-reddit-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://facebook.com/sharer.php?u=https://deepu.tech/kubernetes-secrets-management/" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1' title="Facebook"><i class="fab fa-facebook-f"></i></a></li></ul><div class="sep"></div><ul><li><script type="text/javascript">var HYVOR_TALK_WEBSITE=4123</script><script async type="text/javascript" src="//talk.hyvor.com/web-api/count/"></script><span data-talk-id="https://deepu.tech/kubernetes-secrets-management/"></span></li></ul></div><div class="ad-vertical-md"><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7ITK3I&placement=deeputech" id="_carbonads_js"></script></div></div></div><div class="col-lg-9 flex-first flex-lg-unordered"><div class="mainheading"><h1 class="posttitle">Shhhh... Kubernetes Secrets Are Not Really Secret!</h1><img data-src="https://images.ctfassets.net/23aumh6u8s0i/5sGRuNiW4fSPVSoZjbwkK0/f505f0bdf239fd84fc6b4d128a48d4ed/Deepu_a_container_ship_entering_a_door_lock_lens_flare_photorea_66931d74-fd55-456a-93e0-48e0ad9e927b.png" alt="Shhhh... Kubernetes Secrets Are Not Really Secret!" class="featured-image img-fluid lozad" src="/assets/images/placeholder.jpg"><div class="row post-top-meta"><div class="col-12 text-center text-md-left mb-4 mb-md-0"><img class="author-thumb lozad" src="/assets/images/placeholder.jpg" data-src="https://www.gravatar.com/avatar/7f408bc67dc9ae3b288ee92d16d3c4c2?s=250&d=mm&r=x" alt="Deepu K Sasidharan"> <a target="_blank" class="link-dark" href="https://www.deepu.tech">Deepu K Sasidharan</a><a target="_blank" href="https://mastodon.social/@deepu105" class="btn follow"><i class="fab fa-mastodon"></i> Follow</a><span class="separator d-none d-md-inline-block">| </span><span class="author-description"><small><time class="post-date" datetime="2022-12-15">15 Dec 2022</time> </small><span class="separator d-inline-block">| </span><small>10 mins read </small><span class="separator d-inline-block d-lg-none">| </span><span class="d-inline-block d-lg-none"><div class="share" style="margin-top:0"><ul><li class="ml-1 mr-1"><div class="mast-share mast-share-sm"><input type="checkbox" class="mast-check-toggle"><div class="mast-instance"><span>Instance: </span><input type="textbox" name="mast-instance-input" placeholder="mastodon.social"> <button class="mast-share-button">Share</button></div><label title="Mastodon" class="mast-top mast-check-label"><i class="fab fa-mastodon"></i></label></div><script>Array.prototype.forEach || (Array.prototype.forEach = function (r) { var o, t; if (null == this) throw new TypeError("this is null or not defined"); var n = Object(this), e = n.length >>> 0; if ("function" != typeof r) throw new TypeError(r + " is not a function"); for (arguments.length > 1 && (o = arguments[1]), t = 0; t < e;) { var i; t in n && (i = n[t], r.call(o, i, t, n)), t++ } }); document.addEventListener("DOMContentLoaded", function () { document.querySelectorAll(".mast-share").forEach(function (e, t) { e.querySelector(".mast-check-toggle").id = "mast-check-toggle-" + t, e.querySelector(".mast-check-label").htmlFor = "mast-check-toggle-" + t, e.querySelector(".mast-share-button").addEventListener("click", function (t) { var a = new RegExp("^(?:(?:https?|ftp)://)?(?:\\S+(?::\\S*)?@|\\d{1,3}(?:\\.\\d{1,3}){3}|(?:(?:[a-z\\d\\u00a1-\\uffff]+-?)*[a-z\\d\\u00a1-\\uffff]+)(?:\\.(?:[a-z\\d\\u00a1-\\uffff]+-?)*[a-z\\d\\u00a1-\\uffff]+)*(?:\\.[a-z\\u00a1-\\uffff]{2,6}))(?::\\d+)?(?:[^\\s]*)?$", "i"), n = e.querySelector('input[name="mast-instance-input"]'); if (a.test(n.value)) { var o = `http://${n.value.replace(/(^\w+:|^)\/\//, "")}/share?text=${encodeURIComponent(document.title)} ${encodeURIComponent(location.href)}`; window.open(o, "new", "toolbar=no,location=no,status=yes,resizable=yes,scrollbars=yes,height=600,width=400") } else n.classList.add("invalid"), setTimeout(function () { n.classList.remove("invalid") }, 300) }), e.addEventListener("mouseleave", function (t) { e.querySelector(".mast-check-toggle").checked = !1 }) }) });</script></li><li class="ml-1 mr-1"><a target="_blank" href="https://twitter.com/intent/tweet?text=Shhhh... Kubernetes Secrets Are Not Really Secret! by @deepu105 &url=https://deepu.tech/kubernetes-secrets-management/" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1' title="Twitter"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://deepu.tech/kubernetes-secrets-management/" onclick='return window.open(this.href,"linkedin-share","width=550,height=435"),!1' title="Linkedin"><i class="fab fa-linkedin-in"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://news.ycombinator.com/submitlink?u=https://deepu.tech/kubernetes-secrets-management/&t=Shhhh... Kubernetes Secrets Are Not Really Secret!" onclick='return window.open(this.href,"hackernews-share","width=550,height=435"),!1' title="Hacker News"><i class="fab fa-hacker-news-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.reddit.com/submit?url=https://deepu.tech/kubernetes-secrets-management/&title=Shhhh... Kubernetes Secrets Are Not Really Secret!" onclick='return window.open(this.href,"reddit-share","width=550,height=435"),!1' title="Reddit"><i class="fab fa-reddit-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://facebook.com/sharer.php?u=https://deepu.tech/kubernetes-secrets-management/" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1' title="Facebook"><i class="fab fa-facebook-f"></i></a></li></ul></div></span></span></div></div></div><div class="article-post"><p><em>Originally published at <a href="https://auth0.com/blog/kubernetes-secrets-management/">auth0.com</a></em></p><p>Kubernetes has become an inevitable part of the modern software infrastructure. Hence managing sensitive data on Kubernetes is also an essential aspect of modern software engineering so that you can put the security back into DevSecOps. Kubernetes offers a way to store sensitive data using the <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Secret</a> object. While it’s better than nothing, it is not really a secret, as it is just <a href="https://en.wikipedia.org/wiki/Base64">base64</a> encoded strings that anyone with access to the cluster or the code can decode.</p><blockquote><p><strong>Caution:</strong> Kubernetes Secrets are, by default, stored unencrypted in the API server’s underlying data store (etcd). Anyone with API access can retrieve or modify a Secret, and so can anyone with access to etcd. Additionally, anyone authorized to create a Pod in a namespace can use that access to read any Secret in that namespace; this includes indirect access, such as the ability to create a Deployment. — <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes docs</a></p></blockquote><p>The problem of reading secrets from the cluster can be fixed using proper <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC</a> configuration and by securing the API server, check out <a href="https://developer.okta.com/blog/2021/12/02/k8s-security-best-practices">How to Secure Your Kubernetes Clusters With Best Practices</a> to learn more about RBAC and cluster API security. Securing secrets on the source code is the bigger problem. Everyone who has access to the repositories containing those secret definitions can also decode them. This makes it quite tricky to manage Kubernetes secrets in Git, like every other resource.</p><p>Let’s see how to setup more secure secrets using the;</p><ul><li>Sealed Secrets,</li><li>External Secrets Operator,</li><li>Secrets Store CSI driver.</li></ul><p>You would need a Kubernetes cluster to run the samples. I used <a href="https://k3d.io/">k3d</a> to create a local cluster. You can also use <a href="https://kind.sigs.k8s.io/">kind</a> or <a href="https://minikube.sigs.k8s.io/docs/">minikube</a> for this purpose.</p><h2 id="sealed-secrets">Sealed Secrets</h2><p><a href="https://github.com/bitnami-labs/sealed-secrets">Sealed Secrets</a> is an open-source Kubernetes controller and a client-side CLI tool from Bitnami that aims to solve the “<strong>storing secrets in Git</strong>” part of the problem, using asymmetric crypto encryption. Sealed Secrets with an RBAC configuration preventing non-admins from reading secrets is an excellent solution for the entire problem.</p><p><img src="https://images.ctfassets.net/23aumh6u8s0i/5Ku8H6vSbhV1rECmEYV3q7/07b8d6a66aabff4534d84095d0d1687a/sealed-secrets-architecture.jpg" alt="Sealed Secrets Architecture"></p><p>It works as below;</p><ol><li>Encrypt the secret on the developer machine using a public key and the <code class="language-plaintext highlighter-rouge">kubeseal</code> CLI. This encodes the encrypted secret into a Kubernetes Custom Resource Definition (CRD)</li><li>Deploy the CRD to the target cluster</li><li>The Sealed Secret controller decrypts the secret using a private key on the target cluster to produce a standard Kubernetes secret.</li></ol><p>The private key is only available to the Sealed Secrets controller on the cluster, and the public key is available to the developers. This way, <strong>only the cluster can decrypt the secrets, and the developers can only encrypt them</strong>.</p><h3 id="advantages">Advantages</h3><ul><li>Supports template definition so that metadata can be added to the unsealed secrets. For example, you can add labels and annotations to the unsealed secrets using the template definition.</li><li>The unsealed secrets will be owned by the sealed secret CRD and updated when the sealed secrets are updated.</li><li>Certificates are rotated every 30 days by default, and this can be customized.</li><li>Secrets are encrypted using unique keys for each cluster, namespace, and secret combination (private key + namespace name + secret name), preventing any loopholes in decryption. This behavior is configurable using scopes <code class="language-plaintext highlighter-rouge">strict</code>, <code class="language-plaintext highlighter-rouge">namespace-wide</code>, and <code class="language-plaintext highlighter-rouge">cluster-wide</code> during the sealing process.</li><li>Can be used to manage existing secrets in the cluster.</li><li>Has a <a href="https://marketplace.visualstudio.com/items?itemName=codecontemplator.kubeseal">VSCode extension</a> to make it easier to use.</li></ul><h3 id="disadvantages">Disadvantages</h3><ul><li>Since it unseals the sealed secrets into regular secrets, you can still decode them if you have access to the cluster and namespace.</li><li>Requires resealing for each cluster environment, as the key pair will be unique for each cluster.</li></ul><h3 id="installation">Installation</h3><p>Install the controller on the cluster and the CLI on the local machine.</p><ol><li>Download the <code class="language-plaintext highlighter-rouge">controller.yaml</code> manifest file from the <a href="https://github.com/bitnami-labs/sealed-secrets/releases">release</a> page.</li><li>Deploy the controller using <code class="language-plaintext highlighter-rouge">kubectl apply -f controller.yaml</code> to your cluster. The controller will be installed on the <code class="language-plaintext highlighter-rouge">kube-system</code> namespace. The controller will start and be ready in a few moments.</li><li>Install the CLI on your local machine using <code class="language-plaintext highlighter-rouge">brew install kubeseal</code> (Linux &amp; macOS) or using the pre-built binaries on the <a href="https://github.com/bitnami-labs/sealed-secrets/releases">release</a> page.</li></ol><h3 id="usage">Usage</h3><p>Let’s create a sealed secret.</p><ol><li>Create a secret using the <code class="language-plaintext highlighter-rouge">kubectl create secret</code> command or by hand coding a YAML file as follows:</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nt">-n</span> secretvalue | kubectl create secret generic mysecret <span class="se">\</span>
  <span class="nt">--dry-run</span><span class="o">=</span>client <span class="se">\</span>
  <span class="nt">--from-file</span><span class="o">=</span><span class="nv">foo</span><span class="o">=</span>/dev/stdin <span class="nt">-o</span> yaml <span class="o">&gt;</span> my-secret.yaml
</pre></td></tr></tbody></table></code></pre></div></div><p>This will produce a secret definition like the one below;</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1"># my-secret.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">foo</span><span class="pi">:</span> <span class="s">c2VjcmV0dmFsdWU=</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysecret</span>
</pre></td></tr></tbody></table></code></pre></div></div><ol><li>Seal the secret using the <code class="language-plaintext highlighter-rouge">kubeseal</code> CLI. This will encrypt the secret using the public key fetched from the server and produce a sealed secret definition. The <code class="language-plaintext highlighter-rouge">my-secret.yaml</code> file can be discarded now. You can also download the public key and use it locally in offline mode.</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubeseal <span class="nt">--format</span> yaml &lt; my-secret.yaml <span class="o">&gt;</span> my-sealed-secret.yaml
</pre></td></tr></tbody></table></code></pre></div></div><p>This will produce a sealed secret definition, <code class="language-plaintext highlighter-rouge">my-sealed-secret.yaml</code>, like the one below;</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1"># my-sealed-secret.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">bitnami.com/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">SealedSecret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysecret</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">encryptedData</span><span class="pi">:</span>
    <span class="na">foo</span><span class="pi">:</span> <span class="s">AgA6a4AGzd7qzR8mTPqTPFNor8tTtT5...==</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="no">null</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">mysecret</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>This file is safe to commit to Git or to share with other developers.</p><ol><li>Finally, you can deploy this to the cluster to be unsealed.</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> my-sealed-secret.yaml
</pre></td></tr></tbody></table></code></pre></div></div><ol><li>Now, you can see the unsealed secret in the cluster.</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl describe secret mysecret
</pre></td></tr></tbody></table></code></pre></div></div><p>You can use this secret in deployments like any other Kubernetes secret.</p><h2 id="external-secrets-operator">External Secrets Operator</h2><p>Sealed Secrets are a great starting point for securing secrets, but there is an even better way. Using the <a href="https://external-secrets.io/">External Secrets Operator (ESO)</a> and an external secret management system like <a href="https://www.vaultproject.io/">HashiCorp Vault</a>, <a href="https://aws.amazon.com/secrets-manager/">AWS Secrets Manager</a>, <a href="https://cloud.google.com/secret-manager">Google Secrets Manager</a>, or <a href="https://azure.microsoft.com/en-us/services/key-vault/">Azure Key Vault</a>. While this is a bit more involved to set up, it is a better approach if you use a cloud provider to host your Kubernetes cluster. ESO supports many such secret managers and watches for changes to external secret stores, and keeps Kubernetes secrets in sync.</p><p><img src="https://images.ctfassets.net/23aumh6u8s0i/3zlSSXIMQQq0lhw19cY5Me/42782ce30606ff156b49e6879de3b589/external-secrets-operator-architecture.jpg" alt="External Secrets Operator Architecture"></p><p>ESO provides four CRDs to manage secrets. The <code class="language-plaintext highlighter-rouge">ExternalSecret</code> and <code class="language-plaintext highlighter-rouge">ClusterExternalSecret</code> CRD define what data needs to be fetched and how it should be transformed. The <code class="language-plaintext highlighter-rouge">SecretStore</code> and <code class="language-plaintext highlighter-rouge">ClusterSecretStore</code> CRD define the connection details to the external secret stores. The <code class="language-plaintext highlighter-rouge">Cluster</code> variations can be used cluster-wide.</p><p>It works as below;</p><ol><li>Create a <code class="language-plaintext highlighter-rouge">SecretStore</code> CRD to define the connection details to the external secret store.</li><li>Create secrets in the external secret store.</li><li>Create an <code class="language-plaintext highlighter-rouge">ExternalSecret</code> CRD to define what data needs to be fetched from the external secret store.</li><li>Deploy the CRDs to the target cluster.</li><li>The ESO controller will fetch the data from the external secret store and create a Kubernetes secret.</li></ol><h3 id="advantages-1">Advantages</h3><ul><li>Secrets are stored in a secure external secret manager, not the code repository.</li><li>Keeps secrets in sync with the external secret manager.</li><li>Works with many external secret managers.</li><li>Can use multiple secret stores in the same cluster.</li><li>Provides <a href="https://prometheus.io/">Prometheus</a> metrics for monitoring.</li></ul><h3 id="disadvantages-1">Disadvantages</h3><ul><li>Needs an elaborate setup to use.</li><li>Creates a Kubernetes secret object which can be decoded if you have access to the cluster and namespace.</li><li>Relies on the external secret manager and its access policies to be secure.</li></ul><h3 id="installation-1">Installation</h3><p>ESO can be installed via <a href="https://helm.sh/">Helm</a> using the following commands:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>helm repo add external-secrets https://charts.external-secrets.io

helm <span class="nb">install </span>external-secrets <span class="se">\</span>
  external-secrets/external-secrets <span class="se">\</span>
  <span class="nt">--namespace</span> external-secrets <span class="se">\</span>
  <span class="nt">--create-namespace</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>If you want to include ESO in your Helm releases, add the <code class="language-plaintext highlighter-rouge">--set installCRDs=true</code> flag to the above command.</p><p>Let’s see how you can use ESO with different secret managers.</p><h3 id="using-hashicorp-vault">Using HashiCorp Vault</h3><p><a href="https://www.vaultproject.io/">HashiCorp Vault</a> is a popular secret manager providing different secret engines. ESO can only be used with the <a href="https://www.vaultproject.io/docs/secrets/kv">KV Secrets Engine</a> offered by Vault. Vault provides a free and open-source version that you can self-manage and a managed version with a free tier on the HashiCorp Cloud Platform (HCP).</p><p>Make sure you have a Key-value secret store setup in <a href="https://developer.hashicorp.com/vault/tutorials/getting-started">your local Vault instance</a> or on the <a href="https://developer.hashicorp.com/vault/tutorials/cloud">HCP cloud</a>. You can also <a href="https://blog.container-solutions.com/tutorialexternal-secrets-with-hashicorp-vault">deploy Vault to your Kubernetes cluster</a> using the <a href="https://www.vaultproject.io/docs/platform/k8s/helm">Vault Helm chart</a></p><ol><li>Create a new <code class="language-plaintext highlighter-rouge">SecretStore</code> CRD, <code class="language-plaintext highlighter-rouge">vault-backend.yaml</code>, to define the connection details to Vault.</li></ol><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c1"># vault-backend.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">external-secrets.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">SecretStore</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-backend</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">provider</span><span class="pi">:</span>
    <span class="na">vault</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span> <span class="s2">"</span><span class="s">YOUR_VAULT_ADDRESS"</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">secret"</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">v2"</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">admin"</span> <span class="c1"># required for HCP Vault</span>
      <span class="na">auth</span><span class="pi">:</span>
        <span class="c1"># points to a secret that contains a vault token</span>
        <span class="c1"># https://www.vaultproject.io/docs/auth/token</span>
        <span class="na">tokenSecretRef</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">vault-token"</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">token"</span>
</pre></td></tr></tbody></table></code></pre></div></div><ol><li>Create a secret resource to hold the Vault token. Use a token that has <a href="https://www.vaultproject.io/docs/concepts/policies">policies</a> with read access to the <code class="language-plaintext highlighter-rouge">secret/</code> path in the Vault KV store.</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>kubectl create secret generic vault-token <span class="se">\</span>
  <span class="nt">--dry-run</span><span class="o">=</span>client <span class="se">\</span>
  <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">token</span><span class="o">=</span>YOUR_VAULT_TOKEN
</pre></td></tr></tbody></table></code></pre></div></div><ol><li>Create a secret in Vault. If you are using the Vault CLI, you can use the below command to create a secret. Make sure you are logged in to the vault instance from the CLI with appropriate policies.</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>vault kv put secret/mysecret my-value<span class="o">=</span>supersecret
</pre></td></tr></tbody></table></code></pre></div></div><ol><li>Create an <code class="language-plaintext highlighter-rouge">ExternalSecret</code> CRD to define what data needs to be fetched from Vault.</li></ol><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c1"># vault-secret.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">external-secrets.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ExternalSecret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">vault-example</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">refreshInterval</span><span class="pi">:</span> <span class="s2">"</span><span class="s">15s"</span>
  <span class="na">secretStoreRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">vault-backend</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">SecretStore</span>
  <span class="na">target</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">vault-example-sync</span>
  <span class="na">data</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">secretKey</span><span class="pi">:</span> <span class="s">secret-from-vault</span>
      <span class="na">remoteRef</span><span class="pi">:</span>
        <span class="na">key</span><span class="pi">:</span> <span class="s">secret/mysecret</span>
        <span class="na">property</span><span class="pi">:</span> <span class="s">my-value</span>
</pre></td></tr></tbody></table></code></pre></div></div><ol><li>Apply the above CRDs to the cluster, and it should create a Kubernetes secret named <code class="language-plaintext highlighter-rouge">vault-example-sync</code> with the data fetched from Vault.</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> vault-backend.yaml
kubectl apply <span class="nt">-f</span> vault-secret.yaml
</pre></td></tr></tbody></table></code></pre></div></div><p>You can see the secret in the cluster using the <code class="language-plaintext highlighter-rouge">kubectl describe</code> command.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>kubectl describe secret vault-example-sync

<span class="c"># output should have the below data</span>
Name:         vault-example-sync
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  reconcile.external-secrets.io/data-hash: ...

Type:  Opaque

Data
<span class="o">====</span>
secret-from-vault:  16 bytes
</pre></td></tr></tbody></table></code></pre></div></div><p><strong>If you have issues creating the secret</strong>, check the events section of the describe output of the <code class="language-plaintext highlighter-rouge">ExternalSecret</code> resource.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl describe externalsecret vault-example
</pre></td></tr></tbody></table></code></pre></div></div><p>If you see permission errors, make sure you use tokens with the right policies.</p><h3 id="other-secret-managers">Other secret managers</h3><p>Setting up other secret managers is similar to the above steps. The only difference would be the <code class="language-plaintext highlighter-rouge">SecretStore</code> CRD and the <code class="language-plaintext highlighter-rouge">remoteRef</code> section in the <code class="language-plaintext highlighter-rouge">ExternalSecret</code> CRD. You can find official guides for different providers in the <a href="https://external-secrets.io/">ESO documentation</a>.</p><h2 id="secrets-store-csi-driver">Secrets Store CSI Driver</h2><p>The <a href="https://secrets-store-csi-driver.sigs.k8s.io/">Secrets Store CSI Driver</a> is a native upstream Kubernetes driver that can be used to abstract where the secret is stored from the workload. If you want to use a cloud provider’s secret manager without exposing the secrets as Kubernetes Secret objects, you can use the CSI Driver to mount secrets as volumes in your pods. This is a great option if you use a cloud provider to host your Kubernetes cluster. The driver supports many cloud providers and can be used with different secret managers.</p><p><img src="https://images.ctfassets.net/23aumh6u8s0i/20smaU4zvY0Wt4WKeYTrXu/bdf68ba47b6b630a0ed162fd12ff5f0f/secret-csi-driver.jpg" alt="Secrets Store CSI Driver Architecture"></p><p>The Secrets Store CSI Driver is a daemonset that communicates with the secret provider to retrieve secrets specified in a <code class="language-plaintext highlighter-rouge">SecretProviderClass</code> custom resource.</p><p>It works as below;</p><ol><li>Create a <code class="language-plaintext highlighter-rouge">SecretProviderClass</code> CRD to define the details of the secret to be fetched from the secret provider.</li><li>Create deployments and reference the <code class="language-plaintext highlighter-rouge">SecretProviderClass</code> in the pod’s volume spec.</li><li>The driver will fetch the secret from the secret provider and mount it as a <code class="language-plaintext highlighter-rouge">tmpfs</code> volume in the pod during pod startup. This volume will be removed during pod deletion.</li></ol><p>The driver can also sync changes to secrets. The driver currently supports <a href="https://github.com/hashicorp/secrets-store-csi-driver-provider-vault">Vault</a>, <a href="https://github.com/aws/secrets-store-csi-driver-provider-aws">AWS</a>, <a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure">Azure</a>, and <a href="https://github.com/GoogleCloudPlatform/secrets-store-csi-driver-provider-gcp">GCP</a> providers. Secrets Store CSI Driver can also sync provider secrets as Kubernetes secrets; if required, this behavior needs to be explicitly enabled during installation.</p><h3 id="advantages-2">Advantages</h3><ul><li>Secrets are stored in a secure external secret manager, not the code repository.</li><li>Keeps secrets in sync with the external secret manager. It also supports the rotation of secrets.</li><li>Works with all major external secret managers.</li><li>Mounts secrets as volumes in the pod so they are not exposed as Kubernetes secrets. It can be configured to create Kubernetes secrets as well.</li></ul><h3 id="disadvantages-2">Disadvantages</h3><ul><li>Needs an elaborate setup to use and is more complex than ESO.</li><li>Uses more resources than ESO as this needs to run in every node.</li><li>Relies on the external secret store and its access policies to be secure.</li></ul><h3 id="using-google-secret-manager-provider">Using Google Secret Manager provider</h3><p>Let us see how to configure the driver to use Google Secret Manager (GSM) as the secret provider.</p><p>Make sure you are using a Google Kubernetes Engine (GKE) cluster with the <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a> feature enabled. Workload Identity allows workloads in your GKE clusters to impersonate Identity and Access Management (IAM) service accounts to access Google Cloud services. You would also need to enable Kubernetes Engine API, Secret Manager API, and Billing for the project. The <code class="language-plaintext highlighter-rouge">gcloud</code> CLI should prompt you to enable these APIs if they are not enabled.</p><p>The below command can be used to create a new cluster with Workload Identity enabled using the <code class="language-plaintext highlighter-rouge">gcloud</code> CLI.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">PROJECT_ID</span><span class="o">=</span>&lt;your gcp project&gt;
gcloud config <span class="nb">set </span>project <span class="nv">$PROJECT_ID</span>

gcloud container clusters create hello-hipster <span class="se">\</span>
  <span class="nt">--workload-pool</span><span class="o">=</span><span class="nv">$PROJECT_ID</span>.svc.id.goog
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="install-the-secrets-store-csi-driver">Install the Secrets Store CSI Driver</h4><p>Secrets Store CSI Driver can be installed on the cluster with Helm using the following commands:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts

helm <span class="nb">install </span>csi-secrets-store <span class="se">\</span>
    secrets-store-csi-driver/secrets-store-csi-driver <span class="se">\</span>
    <span class="nt">--namespace</span> kube-system
</pre></td></tr></tbody></table></code></pre></div></div><p>This will install the driver and CRDs on the <code class="language-plaintext highlighter-rouge">kube-system</code> namespace. You also need to install the provider required into the cluster.</p><h4 id="install-the-gsm-provider">Install the GSM provider</h4><p>Let us install the GSM provider into the cluster. The provider can be installed using the following command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/GoogleCloudPlatform/secrets-store-csi-driver-provider-gcp/main/deploy/provider-gcp-plugin.yaml
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="create-a-secret">Create a Secret</h4><p>First, you need to setup a workload identity service account.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c"># Create a service account for workload identity</span>
gcloud iam service-accounts create gke-workload

<span class="c"># Allow "default/mypod" to act as the new service account</span>
gcloud iam service-accounts add-iam-policy-binding <span class="se">\</span>
    <span class="nt">--role</span> roles/iam.workloadIdentityUser <span class="se">\</span>
    <span class="nt">--member</span> <span class="s2">"serviceAccount:</span><span class="nv">$PROJECT_ID</span><span class="s2">.svc.id.goog[default/mypodserviceaccount]"</span> <span class="se">\</span>
    gke-workload@<span class="nv">$PROJECT_ID</span>.iam.gserviceaccount.com
</pre></td></tr></tbody></table></code></pre></div></div><p>Now let’s create a secret that this service account can access.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c"># Create a secret with 1 active version</span>
<span class="nb">echo</span> <span class="s2">"mysupersecret"</span> <span class="o">&gt;</span> secret.data
gcloud secrets create testsecret <span class="nt">--replication-policy</span><span class="o">=</span>automatic <span class="nt">--data-file</span><span class="o">=</span>secret.data
<span class="nb">rm </span>secret.data

<span class="c"># grant the new service account permission to access the secret</span>
gcloud secrets add-iam-policy-binding testsecret <span class="se">\</span>
    <span class="nt">--member</span><span class="o">=</span>serviceAccount:gke-workload@<span class="nv">$PROJECT_ID</span>.iam.gserviceaccount.com <span class="se">\</span>
    <span class="nt">--role</span><span class="o">=</span>roles/secretmanager.secretAccessor
</pre></td></tr></tbody></table></code></pre></div></div><p>Now you can create a <code class="language-plaintext highlighter-rouge">SecretProviderClass</code> resource that will be used to fetch the secret from GSM. Remember to replace <code class="language-plaintext highlighter-rouge">$PROJECT_ID</code> with your GCP project ID.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1"># secret-provider-class.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">secrets-store.csi.x-k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">SecretProviderClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">app-secrets</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">provider</span><span class="pi">:</span> <span class="s">gcp</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">secrets</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">- resourceName: "projects/$PROJECT_ID/secrets/testsecret/versions/latest"</span>
        <span class="s">path: "good1.txt"</span>
      <span class="s">- resourceName: "projects/$PROJECT_ID/secrets/testsecret/versions/latest"</span>
        <span class="s">path: "good2.txt"</span>
</pre></td></tr></tbody></table></code></pre></div></div><h4 id="create-a-pod">Create a Pod</h4><p>Now you can create a pod that will use the <code class="language-plaintext highlighter-rouge">SecretProviderClass</code> resource to fetch the secret from GSM. Remember to replace <code class="language-plaintext highlighter-rouge">$PROJECT_ID</code> with your GCP project ID.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="c1"># my-pod.yaml</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mypodserviceaccount</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">iam.gke.io/gcp-service-account</span><span class="pi">:</span> <span class="s">gke-workload@$PROJECT_ID.iam.gserviceaccount.com</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mypod</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">mypodserviceaccount</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google.com/cloudsdktool/cloud-sdk:slim</span>
      <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">mypod</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
      <span class="na">stdin</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">stdinOnce</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">terminationMessagePath</span><span class="pi">:</span> <span class="s">/dev/termination-log</span>
      <span class="na">terminationMessagePolicy</span><span class="pi">:</span> <span class="s">File</span>
      <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/secrets"</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mysecret</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysecret</span>
      <span class="na">csi</span><span class="pi">:</span>
        <span class="na">driver</span><span class="pi">:</span> <span class="s">secrets-store.csi.k8s.io</span>
        <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">volumeAttributes</span><span class="pi">:</span>
          <span class="na">secretProviderClass</span><span class="pi">:</span> <span class="s2">"</span><span class="s">app-secrets"</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Apply the above resources to the cluster.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>kubectl apply <span class="nt">-f</span> secret-provider-class.yaml
kubectl apply <span class="nt">-f</span> my-pod.yaml
</pre></td></tr></tbody></table></code></pre></div></div><p>Wait for the pod to start, and then <code class="language-plaintext highlighter-rouge">exec</code> into the pod and check the contents of the mounted files.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mypod /bin/bash
<span class="c"># execute the below command in the pod to see the contents of the mounted secret file</span>
root@mypod:/# <span class="nb">cat</span> /var/secrets/good1.txt
</pre></td></tr></tbody></table></code></pre></div></div><h3 id="other-secret-managers-1">Other secret managers</h3><p>You can find similar guides for the <a href="https://github.com/aws/secrets-store-csi-driver-provider-aws">AWS CSI provider</a>, <a href="https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/getting-started/usage/">Azure CSI provider</a> and <a href="https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-secret-store-driver">Vault CSI provider</a>.</p><h2 id="conclusion">Conclusion</h2><p>Sealed Secrets are a great solution for small teams and projects to secure secrets in Git. For larger teams and projects, the External Secrets Operator or the Secrets Store CSI Driver is a better solution to manage secrets securely. The External Secrets Operator can be used with many secret management systems and is not limited to the ones mentioned above. Of course, this should be used with RBAC to prevent non-admins from reading secrets in the cluster. The Secrets Store CSI Driver might be more involved than ESO, but it is a more native solution.</p><p>Cover image created using <a href="https://midjourney.gitbook.io/">Midjourney</a> under <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a>.</p><hr><p>If you like this article, please leave a like or a comment.</p><p>You can follow me on <a href="https://mastodon.social/@deepu105">Mastodon</a> and <a href="https://www.linkedin.com/in/deepu05/">LinkedIn</a>.</p></div><hr><div class="after-post-cats"><ul class="tags mb-4"></ul></div><div class="after-post-tags"><ul class="tags"><li><a class="smoothscroll" href="/tags#devops">#devops</a></li><li><a class="smoothscroll" href="/tags#devsecops">#devsecops</a></li><li><a class="smoothscroll" href="/tags#kubernetes">#kubernetes</a></li></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="prev d-block col-md-6" href="/rust-terminal-tools-linux-mac-windows-fish-zsh/">&laquo; Rust Easy! Modern Cross-platform Command Line Tools to Supercharge Your Terminal</a> <a class="next d-block col-md-6 text-lg-right" href="/mastodon-for-devs/">Mastodon for Developers: Everything You Need to Know &raquo;</a><div class="clearfix"></div></div><hr></div></div></div><div class="container"><div id="comments" class="row justify-content-center mb-5"><div class="col-md-8"><section class="hyvor"><div id="hyvor-talk-view"></div><script type="text/javascript">var HYVOR_TALK_WEBSITE=4123,HYVOR_TALK_CONFIG={url:"https://deepu.tech/kubernetes-secrets-management/",id:"https://deepu.tech/kubernetes-secrets-management/"}</script><script async type="text/javascript" src="//talk.hyvor.com/web-api/embed"></script></section></div></div></div></div><div class="alertbar"><div class="container text-center"><span>Never miss a <b>story</b> from us, subscribe to our newsletter</span><form action="https://tech.us7.list-manage.com/subscribe/post?u=00729f6c6d6bb180801b9484e&amp;id=f521dede4b" method="post" name="mc-embedded-subscribe-form" id="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate><div class="mc-field-group"><input type="email" placeholder="Email address" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"></div></form></div></div></div><div class="jumbotron fortags lozad" data-background-image="/assets/images/jumbotron.jpg"><div class="d-md-flex h-100"><div class="col-md-4 transpdark align-self-center text-center h-100"><div class="d-md-flex align-items-center justify-content-center h-100"><h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2></div></div><div class="col-md-8 pt-1 ph-2 align-self-center text-center h-100"><a class="mt-1 mb-1" href="/tags#languages">languages (15)</a> <a class="mt-1 mb-1" href="/tags#programming">programming (15)</a> <a class="mt-1 mb-1" href="/tags#java">java (13)</a> <a class="mt-1 mb-1" href="/tags#javascript">javascript (13)</a> <a class="mt-1 mb-1" href="/tags#rust">rust (9)</a> <a class="mt-1 mb-1" href="/tags#beginners">beginners (8)</a> <a class="mt-1 mb-1" href="/tags#concurrency">concurrency (7)</a> <a class="mt-1 mb-1" href="/tags#go">go (7)</a> <a class="mt-1 mb-1" href="/tags#linux">linux (6)</a> <a class="mt-1 mb-1" href="/tags#kubernetes">kubernetes (5)</a> <a class="mt-1 mb-1" href="/tags#microservices">microservices (5)</a> <a class="mt-1 mb-1" href="/tags#typescript">typescript (5)</a> <a class="mt-1 mb-1" href="/tags#computerscience">computerscience (4)</a> <a class="mt-1 mb-1" href="/tags#development">development (4)</a> <a class="mt-1 mb-1" href="/tags#fedora">fedora (4)</a> <a class="mt-1 mb-1" href="/tags#functional">functional (4)</a> <a class="mt-1 mb-1" href="/tags#thepragmaticprogrammer">thepragmaticprogrammer (4)</a> <a class="mt-1 mb-1" href="/tags#async">async (3)</a> <a class="mt-1 mb-1" href="/tags#jhipster">jhipster (3)</a> <a class="mt-1 mb-1" href="/tags#azure">azure (2)</a> <a class="mt-1 mb-1" href="/tags#career">career (2)</a> <a class="mt-1 mb-1" href="/tags#codequality">codequality (2)</a> <a class="mt-1 mb-1" href="/tags#deno">deno (2)</a> <a class="mt-1 mb-1" href="/tags#devops">devops (2)</a> <a class="mt-1 mb-1" href="/tags#discuss">discuss (2)</a> <a class="mt-1 mb-1" href="/tags#docker">docker (2)</a> <a class="mt-1 mb-1" href="/tags#garbagecollection">garbagecollection (2)</a> <a class="mt-1 mb-1" href="/tags#gnome">gnome (2)</a> <a class="mt-1 mb-1" href="/tags#golang">golang (2)</a> <a class="mt-1 mb-1" href="/tags#kde">kde (2)</a> <a class="mt-1 mb-1" href="/tags#node">node (2)</a> <a class="mt-1 mb-1" href="/tags#nodejs">nodejs (2)</a> <a class="mt-1 mb-1" href="/tags#openjdk">openjdk (2)</a> <a class="mt-1 mb-1" href="/tags#react">react (2)</a> <a class="mt-1 mb-1" href="/tags#showdev">showdev (2)</a> <a class="mt-1 mb-1" href="/tags#terminal">terminal (2)</a> <a class="mt-1 mb-1" href="/tags#terraform">terraform (2)</a> <a class="mt-1 mb-1" href="/tags#webassembly">webassembly (2)</a> <a class="mt-1 mb-1" href="/tags#webdev">webdev (2)</a> <a class="mt-1 mb-1" href="/tags#architecture">architecture (1)</a> <a class="mt-1 mb-1" href="/tags#aws">aws (1)</a> <a class="mt-1 mb-1" href="/tags#bash">bash (1)</a> <a class="mt-1 mb-1" href="/tags#blogging">blogging (1)</a> <a class="mt-1 mb-1" href="/tags#books">books (1)</a> <a class="mt-1 mb-1" href="/tags#clojure">clojure (1)</a> <a class="mt-1 mb-1" href="/tags#codenewbie">codenewbie (1)</a> <a class="mt-1 mb-1" href="/tags#desktop">desktop (1)</a> <a class="mt-1 mb-1" href="/tags#developerexperience">developerexperience (1)</a> <a class="mt-1 mb-1" href="/tags#devrel">devrel (1)</a> <a class="mt-1 mb-1" href="/tags#devsecops">devsecops (1)</a> <a class="mt-1 mb-1" href="/tags#distributedsystems">distributedsystems (1)</a> <a class="mt-1 mb-1" href="/tags#engineering">engineering (1)</a> <a class="mt-1 mb-1" href="/tags#gaming">gaming (1)</a> <a class="mt-1 mb-1" href="/tags#ide">ide (1)</a> <a class="mt-1 mb-1" href="/tags#interview">interview (1)</a> <a class="mt-1 mb-1" href="/tags#istio">istio (1)</a> <a class="mt-1 mb-1" href="/tags#jdk">jdk (1)</a> <a class="mt-1 mb-1" href="/tags#Jekyll">Jekyll (1)</a> <a class="mt-1 mb-1" href="/tags#js">js (1)</a> <a class="mt-1 mb-1" href="/tags#jvm">jvm (1)</a> <a class="mt-1 mb-1" href="/tags#kotlin">kotlin (1)</a> <a class="mt-1 mb-1" href="/tags#loom">loom (1)</a> <a class="mt-1 mb-1" href="/tags#macos">macos (1)</a> <a class="mt-1 mb-1" href="/tags#mastodon">mastodon (1)</a> <a class="mt-1 mb-1" href="/tags#medium">medium (1)</a> <a class="mt-1 mb-1" href="/tags#memory-management">memory-management (1)</a> <a class="mt-1 mb-1" href="/tags#motivation">motivation (1)</a> <a class="mt-1 mb-1" href="/tags#multithreading">multithreading (1)</a> <a class="mt-1 mb-1" href="/tags#ohmyzsh">ohmyzsh (1)</a> <a class="mt-1 mb-1" href="/tags#opensource">opensource (1)</a> <a class="mt-1 mb-1" href="/tags#passkeys">passkeys (1)</a> <a class="mt-1 mb-1" href="/tags#patternmatching">patternmatching (1)</a> <a class="mt-1 mb-1" href="/tags#polyglot">polyglot (1)</a> <a class="mt-1 mb-1" href="/tags#pragmatic">pragmatic (1)</a> <a class="mt-1 mb-1" href="/tags#python">python (1)</a> <a class="mt-1 mb-1" href="/tags#ruby">ruby (1)</a> <a class="mt-1 mb-1" href="/tags#scala">scala (1)</a> <a class="mt-1 mb-1" href="/tags#social">social (1)</a> <a class="mt-1 mb-1" href="/tags#spring">spring (1)</a> <a class="mt-1 mb-1" href="/tags#svelte">svelte (1)</a> <a class="mt-1 mb-1" href="/tags#tech">tech (1)</a> <a class="mt-1 mb-1" href="/tags#ubuntu">ubuntu (1)</a> <a class="mt-1 mb-1" href="/tags#v8">v8 (1)</a> <a class="mt-1 mb-1" href="/tags#vr">vr (1)</a> <a class="mt-1 mb-1" href="/tags#vscode">vscode (1)</a> <a class="mt-1 mb-1" href="/tags#web">web (1)</a> <a class="mt-1 mb-1" href="/tags#webauthn">webauthn (1)</a> <a class="mt-1 mb-1" href="/tags#windows">windows (1)</a> <a class="mt-1 mb-1" href="/tags#womenintech">womenintech (1)</a> <a class="mt-1 mb-1" href="/tags#writing">writing (1)</a> <a class="mt-1 mb-1" href="/tags#zsh">zsh (1)</a></div></div></div><footer class="footer"><div class="container"><div class="row"><div class="col-md-6 col-sm-6 text-center text-lg-left">Copyright © 2024 Deepu K Sasidharan<br><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img class="lozad" alt="Creative Commons License" style="border-width:0" src="/assets/images/placeholder.jpg" data-src="https://i.creativecommons.org/l/by/4.0/88x31.png"> </a>Content licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net | Domain by <a href="https://js.org" target="_blank" title="JS.ORG | JavaScript Community"><img src="/assets/images/placeholder.jpg" data-src="https://logo.js.org/dark_tiny.png" style="width:50px" alt="JS.ORG Logo" class="lozad"> </a>| Hosted with <i class="far fa-heart"></i> by <a href="https://pages.github.com/" target="_blank">Github</a></div></div></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.slim.min.js" integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.8/lunr.min.js" integrity="sha256-34Si1Y6llMBKM3G0jQILVeoQKEwuxjbk4zGWXXMT4ps=" crossorigin="anonymous"></script><script async src="/assets/js/lunrsearchengine.js"></script><script async src="/assets/js/mediumish.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.14.0/lozad.min.js" integrity="sha256-hstwhDmGVwZjIwt6SlTG6sQBREWrWTBjVTik/JLlb1Y=" crossorigin="anonymous"></script><script>// lazy loads images
        const lazyloadObserver = lozad()
        lazyloadObserver.observe();</script><script async src="/assets/js/ie10-viewport-bug-workaround.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74370272-6"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-74370272-6")</script></body></html>