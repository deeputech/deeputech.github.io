<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel="icon" href="/assets/images/logo.png"><title>🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly) | Technorage</title><meta name="generator" content="Jekyll v4.1.1"><meta property="og:title" content="🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)"><meta name="author" content="deepu"><meta property="og:locale" content="en_US"><meta name="description" content="Let us take a look at how the V8 engine for JavaScript &amp; WebAssembly manages memory for Browsers and NodeJS."><meta property="og:description" content="Let us take a look at how the V8 engine for JavaScript &amp; WebAssembly manages memory for Browsers and NodeJS."><link rel="canonical" href="https://deepu.tech/memory-management-in-v8/"><meta property="og:url" content="https://deepu.tech/memory-management-in-v8/"><meta property="og:site_name" content="Technorage"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-01-27T00:00:00+01:00"><meta name="twitter:card" content="summary"><meta property="twitter:title" content="🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)"><script type="application/ld+json">{"author":{"@type":"Person","name":"deepu"},"description":"Let us take a look at how the V8 engine for JavaScript &amp; WebAssembly manages memory for Browsers and NodeJS.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://deepu.tech/assets/images/logo.png"},"name":"deepu"},"@type":"BlogPosting","headline":"🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)","dateModified":"2020-01-27T00:00:00+01:00","datePublished":"2020-01-27T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://deepu.tech/memory-management-in-v8/"},"url":"https://deepu.tech/memory-management-in-v8/","@context":"https://schema.org"}</script><link rel="canonical" href="https://deepu.tech/memory-management-in-v8/"><meta property="og:url" content=""><meta name="monetization" content="$ilp.uphold.com/Aw7eGpxKNyK7"><meta name="twitter:site" content="@deepu105"><meta name="twitter:creator" content="@deepu105"><meta name="twitter:title" content="🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)"><meta name="twitter:description" content="Let us take a look at how the V8 engine for JavaScript & WebAssembly manages memory for Browsers and NodeJS."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://i.imgur.com/kSgatSL.png"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha256-L/W5Wfqfa0sdBNIKN9cG6QA5F2qx4qICmU2VgLruv9Y=" crossorigin="anonymous"><link href="/assets/css/screen.css" rel="stylesheet"><link href="/assets/css/main.css" rel="stylesheet"></head><body class="layout-post"><noscript id="deferred-styles"><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" crossorigin="anonymous"></noscript><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down pr-md-0 pl-md-0"><div class="container d-flex align-items-center"><a class="navbar-brand" href="/"><h2 class="sitetitle">Technorage</h2><small class="sitetitlesub">Where I rage about technology and stuff! </small></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarMediumish"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" href="/">About</a></li><li class="nav-item active"><a class="nav-link" href="/blogs/"><i class="fas fa-blog"></i> Blog</a></li><li class="nav-item"><a class="nav-link" href="/books"><i class="fas fa-book"></i> Books</a></li><li class="nav-item"><a target="_blank" class="nav-link" href="https://www.youtube.com/playlist?list=PLxayiD7e52nPpb-sSaoOPc-zXGhmOaNHK"><i class="fab fa-youtube"></i> Videos</a></li><li class="nav-item"><a target="_blank" class="nav-link" href="https://speakerdeck.com/deepu105"><i class="fab fa-speaker-deck"></i> Presentations</a></li><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.slim.min.js" integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.8/lunr.min.js" integrity="sha256-34Si1Y6llMBKM3G0jQILVeoQKEwuxjbk4zGWXXMT4ps=" crossorigin="anonymous"></script><style>.lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}</style><form class="bd-search" onsubmit="return lunr_search(document.getElementById('lunrsearch').value);"><input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."></form><div id="lunrsearchresults"><ul></ul></div><script src="/assets/js/lunrsearchengine.js"></script></ul></div></div></nav><div class="site-content"><div class="container"><div class="main-content"><div class="container mt-5"><div class="row"><div class="col-lg-2 pl-0"><div class="sticky-top sticky-top-offset"><div class="popover-wrapper d-none d-lg-block"><a href="#"><h2 class="popover-title"><i class="fas fa-stream fa-lg"></i> TOC</h2></a><div class="popover-content"><div class="toc lead"><h3 class="font-weight-bold">Summary</h3><ul><li><a href="#v8-memory-structure">V8 memory structure</a><ul><li><a href="#heap-memory">Heap Memory</a></li><li><a href="#stack">Stack</a></li></ul></li><li><a href="#v8-memory-usage-stack-vs-heap">V8 memory usage (Stack vs Heap)</a></li><li><a href="#v8-memory-management-garbage-collection">V8 Memory management: Garbage collection</a><ul><li><a href="#minor-gc-scavenger">Minor GC (Scavenger)</a></li><li><a href="#major-gc">Major GC</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#references">References</a></li></ul></div></div></div><div class="share"><p>Share</p><ul><li class="ml-1 mr-1"><a target="_blank" href="https://twitter.com/intent/tweet?text=🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly) by @deepu105 &url=https://deepu.tech/memory-management-in-v8/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://deepu.tech/memory-management-in-v8/" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=435');return false;" title="Linkedin"><i class="fab fa-linkedin-in"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://news.ycombinator.com/submitlink?u=https://deepu.tech/memory-management-in-v8/&t=🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)" onclick="window.open(this.href, 'hackernews-share', 'width=550,height=435');return false;" title="Hacker News"><i class="fab fa-hacker-news-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.reddit.com/submit?url=https://deepu.tech/memory-management-in-v8/&title=🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)" onclick="window.open(this.href, 'reddit-share', 'width=550,height=435');return false;" title="Reddit"><i class="fab fa-reddit-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://facebook.com/sharer.php?u=https://deepu.tech/memory-management-in-v8/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;" title="Facebook"><i class="fab fa-facebook-f"></i></a></li></ul><div class="sep"></div><ul><li><script type="text/javascript">var HYVOR_TALK_WEBSITE = 4123;</script><script async type="text/javascript" src="//talk.hyvor.com/web-api/count/"></script><span data-talk-id="https://deepu.tech/memory-management-in-v8/"></span></li></ul></div><div class="ad-vertical-md"><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7ITK3I&placement=deeputech" id="_carbonads_js"></script></div></div></div><div class="col-lg-9 flex-first flex-lg-unordered"><div class="mainheading"><h1 class="posttitle">🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)</h1><img data-src="https://i.imgur.com/kSgatSL.png" alt="🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)" class="featured-image img-fluid lozad" src="/assets/images/placeholder.jpg"><div class="row post-top-meta"><div class="col-12 text-center text-md-left mb-4 mb-md-0"><img class="author-thumb lozad" src="/assets/images/placeholder.jpg" data-src="https://www.gravatar.com/avatar/7f408bc67dc9ae3b288ee92d16d3c4c2?s=250&d=mm&r=x" alt="Deepu K Sasidharan"> <a target="_blank" class="link-dark" href="https://www.deepu.tech">Deepu K Sasidharan</a><a target="_blank" href="https://twitter.com/deepu105" class="btn follow">Follow</a><span class="separator d-none d-md-inline-block">| </span><span class="author-description"><small><time class="post-date" datetime="2020-01-27">27 Jan 2020</time> </small><span class="separator d-inline-block">| </span><small>14 mins read</small> <span class="separator d-inline-block d-lg-none">| </span><span class="d-inline-block d-lg-none"><div class="share" style="margin-top: 0;"><ul><li class="ml-1 mr-1"><a target="_blank" href="https://twitter.com/intent/tweet?text=🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly) by @deepu105 &url=https://deepu.tech/memory-management-in-v8/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://deepu.tech/memory-management-in-v8/" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=435');return false;" title="Linkedin"><i class="fab fa-linkedin-in"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://news.ycombinator.com/submitlink?u=https://deepu.tech/memory-management-in-v8/&t=🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)" onclick="window.open(this.href, 'hackernews-share', 'width=550,height=435');return false;" title="Hacker News"><i class="fab fa-hacker-news-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.reddit.com/submit?url=https://deepu.tech/memory-management-in-v8/&title=🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)" onclick="window.open(this.href, 'reddit-share', 'width=550,height=435');return false;" title="Reddit"><i class="fab fa-reddit-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://facebook.com/sharer.php?u=https://deepu.tech/memory-management-in-v8/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;" title="Facebook"><i class="fab fa-facebook-f"></i></a></li></ul></div></span></span></div></div></div><div class="panel"><p><strong>This is part of my "memory-management" series</strong></p><ol><li><a href="/memory-management-in-programming/">🚀 Demystifying memory management in modern programming languages</a></li><li><a href="/memory-management-in-jvm/">🚀 Visualizing memory management in JVM(Java, Kotlin, Scala, Groovy, Clojure)</a></li><li><strong>🚀 Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)</strong></li><li><a href="/memory-management-in-golang/">🚀 Visualizing memory management in Golang</a></li><li><a href="/memory-management-in-rust/">🚀 Visualizing memory management in Rust</a></li><li><a href="/avoiding-memory-leaks-in-nodejs/">Avoiding Memory Leaks in NodeJS: Best Practices for Performance</a></li></ol></div><div class="article-post"><p>Please follow me on <a href="https://twitter.com/deepu105">Twitter</a> for updates and let me know if something can be improved in the post.</p><hr><p>In this multi-part series, I aim to demystify the concepts behind memory management and take a deeper look at memory management in some of the modern programming languages. I hope the series would give you some insights into what is happening under the hood of these languages in terms of memory management.</p><p>In this chapter, we will look at the memory management of the <strong><a href="https://v8.dev/">V8 Engine</a></strong> for <a href="https://tc39.es/ecma262/">ECMAScript</a> and <a href="https://webassembly.github.io/spec/core/">WebAssembly</a>, used by runtimes like NodeJS, Deno &amp; Electron and web browsers like Chrome, Chromium, Brave, Opera, and Microsoft Edge. Since JavaScript is an interpreted language, it needs an engine to interpret and execute code. The V8 engine interprets JavaScript and compiles it down to native machine code. V8 is written in C++ and can be embedded in any C++ application.</p><p>If you haven’t read the <a href="https://deepu.tech/memory-management-in-programming/">first part</a> of this series, please read it first as I explained the difference between the Stack and Heap memory there which would be useful to understand this chapter.</p><h1 id="v8-memory-structure">V8 memory structure</h1><p>First, let us see what the memory structure of the V8 engine is. Since JavaScript is single-threaded V8 also uses a single process per JavaScript context and hence if you use service workers it will spawn a new V8 process per worker. A running program is always represented by some allocated memory in the V8 process and this is called <strong>Resident Set</strong>. This is further divided into different segments as below:</p><p><img src="https://i.imgur.com/kSgatSL.png" alt="V8 Memory structure"></p><p>This is slightly similar to the JVM memory structure we saw in the <a href="https://deepu.tech/memory-management-in-jvm/">previous chapter</a>. Let us see what the different segments are for:</p><h2 id="heap-memory">Heap Memory</h2><p>This is where V8 stores objects or dynamic data. This is the biggest block of memory area and this is where <strong>Garbage Collection(GC)</strong> takes place. The entire heap memory is not garbage collected, only the Young and Old space is managed by garbage collection. Heap is further divided into below:</p><ul><li><strong>New Space</strong>: New space or <strong>“Young generation”</strong> is where new objects live and most of these objects are short-lived. This space is small and has two <strong>semi-space</strong>, similar to <strong>S0</strong> &amp; <strong>S1</strong> in JVM. This space is managed by the <strong>“Scavenger(Minor GC)”</strong>, we will look at it later. The size of the new space can be controlled using the <code class="language-plaintext highlighter-rouge">--min_semi_space_size</code>(Initial) and <code class="language-plaintext highlighter-rouge">--max_semi_space_size</code>(Max) V8 flags.</li><li><strong>Old Space</strong>: Old space or <strong>“Old generation”</strong> is where objects that survived the “New space” for two minor GC cycles are moved to. This space is managed up by the <strong>Major GC(Mark-Sweep &amp; Mark-Compact)”</strong>, we will look at it later. The size of old space can be controlled using the <code class="language-plaintext highlighter-rouge">--initial_old_space_size</code>(Initial) and <code class="language-plaintext highlighter-rouge">--max_old_space_size</code>(Max) V8 flags. This space is divided into two:<ul><li><strong>Old pointer space</strong>: Contains survived objects that have pointers to other objects.</li><li><strong>Old data space</strong>: Contains objects that just contain data(no pointer to other objects). Strings, boxed numbers, and arrays of unboxed doubles are moved here after surviving in “New space” for two minor GC cycles.</li></ul></li><li><strong>Large object space</strong>: This is where objects which are larger than the size limits of other spaces live. Each object gets its own <code class="language-plaintext highlighter-rouge">[mmap](https://en.wikipedia.org/wiki/Mmap)'d</code> region of memory. Large objects are never moved by the garbage collector.</li><li><strong>Code-space</strong>: This is where the <strong>Just In Time(JIT)</strong> compiler stores compiled code Blocks. This is the only space with executable memory (although <code class="language-plaintext highlighter-rouge">Codes</code> may be allocated in “Large object space”, and those are executable, too).</li><li><strong>Cell space, property cell space, and map space</strong>: These spaces contain <code class="language-plaintext highlighter-rouge">Cells</code>, <code class="language-plaintext highlighter-rouge">PropertyCells</code>, and <code class="language-plaintext highlighter-rouge">Maps</code>, respectively. Each of these spaces contains objects which are all the same size and has some constraints on what kind of objects they point to, which simplifies collection.</li></ul><p>Each of these spaces is composed of a set of pages. A Page is a contiguous chunk of memory allocated from the operating system with <code class="language-plaintext highlighter-rouge">mmap</code> (or <code class="language-plaintext highlighter-rouge">[MapViewOfFile](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-mapviewoffile)</code> on Windows). Each page is 1MB in size, except for Large object space.</p><h2 id="stack">Stack</h2><p>This is the stack memory area and there is one stack per V8 process. This is where static data including method/function frames, primitive values, and pointers to objects are stored. The stack memory limit can be set using the <code class="language-plaintext highlighter-rouge">--stack_size</code> V8 flag.</p><hr><h1 id="v8-memory-usage-stack-vs-heap">V8 memory usage (Stack vs Heap)</h1><p>Now that we are clear about how memory is organized let’s see how the most important parts of it are used when a program is executed.</p><p>Let’s use the below JavaScript program, the code is not optimized for correctness hence ignore issues like unnecessary intermediatory variables and such, the focus is to visualize stack and heap memory usage.</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">class</span> <span class="nx">Employee</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">salary</span><span class="p">,</span> <span class="nx">sales</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">salary</span> <span class="o">=</span> <span class="nx">salary</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sales</span> <span class="o">=</span> <span class="nx">sales</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">BONUS_PERCENTAGE</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">getBonusPercentage</span><span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">salary</span> <span class="o">*</span> <span class="nx">BONUS_PERCENTAGE</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">percentage</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">findEmployeeBonus</span><span class="p">(</span><span class="nx">salary</span><span class="p">,</span> <span class="nx">noOfSales</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">bonusPercentage</span> <span class="o">=</span> <span class="nx">getBonusPercentage</span><span class="p">(</span><span class="nx">salary</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">bonus</span> <span class="o">=</span> <span class="nx">bonusPercentage</span> <span class="o">*</span> <span class="nx">noOfSales</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">bonus</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">john</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Employee</span><span class="p">(</span><span class="dl">"</span><span class="s2">John</span><span class="dl">"</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="nx">john</span><span class="p">.</span><span class="nx">bonus</span> <span class="o">=</span> <span class="nx">findEmployeeBonus</span><span class="p">(</span><span class="nx">john</span><span class="p">.</span><span class="nx">salary</span><span class="p">,</span> <span class="nx">john</span><span class="p">.</span><span class="nx">sales</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">john</span><span class="p">.</span><span class="nx">bonus</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>Click on the slides and move forward/backward using arrow keys to see how the above program is executed and how the stack and heap memory is used:</p><p><script async="" class="speakerdeck-embed" data-id="e89e2e48a797417eb8692897dcada584" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script><noscript><a href="//speakerdeck.com/player/e89e2e48a797417eb8692897dcada584"><img alt="Speakerdeck" class="lozad" src="{{ site.baseurl }}/assets/images/placeholder.jpg" data-src="//speakerd.s3.amazonaws.com/presentations/e89e2e48a797417eb8692897dcada584/slide_0.jpg"></a></noscript></p><p><em>Note: If the slides look cut off at edges, then click on the title of the slide or <a href="https://speakerdeck.com/deepu105/v8-memory-usage-stack-and-heap">here</a> to open it directly in SpeakerDeck.</em></p><p>As you can see:</p><ul><li><strong>Global scope</strong> is kept in a “Global frame” on the Stack</li><li>Every function call is added to the stack memory as a frame-block</li><li>All local variables including arguments and the return value is saved within the function frame-block on the Stack</li><li>All primitive types like <code class="language-plaintext highlighter-rouge">int</code> &amp; <code class="language-plaintext highlighter-rouge">string</code> are stored directly on the Stack. This applies to global scope as well and yes String is a primitive type of JavaScript</li><li>All object types like <code class="language-plaintext highlighter-rouge">Employee</code> &amp; <code class="language-plaintext highlighter-rouge">Function</code> are created on the Heap and is referenced from the Stack using Stack pointers. Functions are just objects in JavaScript. This applies to global scope as well</li><li>Functions called from the current function is pushed on top of the Stack</li><li>When a function returns its frame is removed from the Stack</li><li>Once the main process is complete, the objects on the Heap do not have any more pointers from Stack and becomes orphan</li><li>Unless you make a copy explicitly, all object references within other objects are done using reference pointers</li></ul><p>The Stack as you can see is automatically managed and is done so by the operating system rather than V8 itself. Hence we do not have to worry much about the Stack. The Heap, on the other hand, is not automatically managed by the OS and since it’s the biggest memory space and holds dynamic data, it could grow exponentially causing our program to run out of memory over time. It also becomes fragmented over time slowing down applications. This is where garbage collection comes in.</p><p>Distinguishing pointers and data on the heap is important for garbage collection and V8 uses the <strong>“Tagged pointers”</strong> approach for this - in this approach, it reserves a bit at the end of each word to indicate whether it is pointer or data. This approach requires limited compiler support, but it’s simple to implement while being fairly efficient.</p><hr><h1 id="v8-memory-management-garbage-collection">V8 Memory management: Garbage collection</h1><p>Now that we know how V8 allocates memory, let us see how it automatically manages the Heap memory which is very important for the performance of an application. When a program tries to allocate more memory on the Heap than that is freely available(depending on the V8 flags set) we encounter <strong>out of memory errors</strong>. An incorrectly managed heap could also cause a memory leak.</p><p>V8 manages the heap memory by garbage collection. In simple terms, it frees the memory used by orphan objects, i.e, objects that are no longer referenced from the Stack directly or indirectly(via a reference in another object) to make space for new object creation.</p><blockquote><p><strong>Orinoco</strong> is the codename of the V8 GC project to make use of parallel, incremental and concurrent techniques for garbage collection, to free the main thread.</p></blockquote><p>The garbage collector in V8 is responsible for reclaiming the unused memory for reuse by the V8 process.</p><p>V8 garbage collectors are generational(Objects in Heap are grouped by their age and cleared at different stages). There are two stages and three different algorithms used for garbage collection by V8:</p><h2 id="minor-gc-scavenger">Minor GC (Scavenger)</h2><p>This type of GC keeps the young or new generation space compact and clean. Objects are allocated in new-space, which is fairly small (between 1 and 8 MB, depending on behavior heuristics). Allocation in “new space” is very cheap: there is an allocation pointer which we increment whenever we want to reserve space for a new object. When the allocation pointer reaches the end of the new space, a minor GC is triggered. This process is also called <strong>Scavenger</strong> and it implements <a href="http://en.wikipedia.org/wiki/Cheney's_algorithm">Cheney’s algorithm</a>. It occurs frequently and uses parallel helper threads and is very fast.</p><p>Let us look at the minor GC process:</p><p>The new space is divided into two equal-sized semi-spaces: <strong>to-space</strong> and <strong>from-space</strong>. Most allocations are made in from-space (except certain kinds of objects, such as executable Codes which are always allocated in old-space). When from-space fills up the minor GC is triggered.</p><p>Click on the slides and move forward/backward using arrow keys to see the process:</p><p><script async="" class="speakerdeck-embed" data-id="5fff2548e55c4bb0a9c837c7eb598bee" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script><noscript><a href="//speakerdeck.com/player/5fff2548e55c4bb0a9c837c7eb598bee"><img alt="Speakerdeck" class="lozad" src="{{ site.baseurl }}/assets/images/placeholder.jpg" data-src="//speakerd.s3.amazonaws.com/presentations/5fff2548e55c4bb0a9c837c7eb598bee/slide_0.jpg"></a></noscript></p><p><em>Note: If the slides look cut off at edges, then click on the title of the slide or <a href="https://speakerdeck.com/deepu105/v8-minor-gc">here</a> to open it directly in SpeakerDeck.</em></p><ol><li>Let us assume that there are already objects on the “from-space” when we start(Blocks 01 to 06 marked as used memory)</li><li>The process creates a new object(07)</li><li>V8 tries to get the required memory from from-space, but there is no free space in there to accommodate our object and hence V8 triggers minor GC</li><li>Minor GC recursively traverses the object graph in “from-space” starting from stack pointers(GC roots) to find objects that are used or alive(Used memory). These objects are moved to a page in the “to-space”. Any objects reference by these objects are also moved to this page in “to-space” and their pointers are updated. This is repeated until all the objects in “from-space” are scanned. By end of this, the “to-space” is automatically compacted reducing fragmentation</li><li>Minor GC now empties the “from-space” as any remaining object here is garbage</li><li>Minor GC swaps the “to-space” and “from-space”, all the objects are now in “from-space” and the “to-space” is empty</li><li>The new object is allocated memory in the “from-space”</li><li>Let us assume that some time has passed and there are more objects on the “from-space” now(Blocks 07 to 09 marked as used memory)</li><li>The application creates a new object(10)</li><li>V8 tries to get required memory from “from-space”, but there is no free space in there to accommodate our object and hence V8 triggers a second minor GC</li><li>The above process is repeated and any alive objects that survived the second minor GC is moved to the “Old space”. First-time survivors are moved to the “to-space” and the remaining garbage is cleared from “from-space”</li><li>Minor GC swaps the “to-space” and “from-space”, all the objects are now in “from-space” and the “to-space” is empty</li><li>The new object is allocated memory in the “from-space”</li></ol><p>So we saw how minor GC reclaims space from the young generation and keeps it compact. It is a stop-the-world process but it’s so fast and efficient that it is negligible most of the time. Since this process doesn’t scan objects in the “old space” for any reference in the “new space” it uses a register of all pointers from old space to new space. This is recorded to the store buffer by a process called <strong><a href="https://www.memorymanagement.org/glossary/w.html#term-write-barrier">write barriers</a></strong>.</p><h2 id="major-gc">Major GC</h2><p>This type of GC keeps the old generation space compact and clean. This is triggered when V8 decides there is not enough old space, based on a dynamically computed limit, as it gets filled up from minor GC cycles.</p><p>The Scavenger algorithm is perfect for small data size but is impractical for large heap, as the old space, as it has memory overhead and hence major GC is done using the <strong>Mark-Sweep-Compact</strong> algorithm. It uses a <strong>tri-color</strong>(white-grey-black) marking system. Hence major GC is a three-step process and the third step is executed depending on a fragmentation heuristic.</p><p><img src="https://i.imgur.com/rcjSZ0T.gif" alt="Mark-sweep-compact GC"></p><ul><li><strong>Marking</strong>: First step, common for both algorithms, where the garbage collector identifies which objects are in use and which ones are not in use. The objects in use or reachable from GC roots(Stack pointers) recursively are marked as alive. It’s technically a depth-first-search of the heap which can be considered as a directed graph</li><li><strong>Sweeping</strong>: The garbage collector traverses the heap and makes note of the memory address of any object that is not marked alive. This space is now marked as free in the free list and can be used to store other objects</li><li><strong>Compacting</strong>: After sweeping, if required, all the survived objects will be moved to be together. This will decrease fragmentation and increase the performance of allocation of memory to newer objects</li></ul><p>This type of GC is also referred to as stop-the-world GC as they introduce pause-times in the process while performing GC. To avoid this V8 uses techniques like</p><p><img src="https://v8.dev/_img/trash-talk/09.svg" alt="The major GC"></p><ul><li><strong>Incremental GC</strong>: GC is done in multiple incremental steps instead of one.</li><li><strong>Concurrent marking</strong>: Marking is done concurrently using multiple helper threads without affecting the main JavaScript thread. Write barriers are used to keep track of new references between objects that JavaScript creates while the helpers are marking concurrently.</li><li><strong>Concurrent sweeping/compacting</strong>: Sweeping and compacting are done in helper threads concurrently without affecting the main JavaScript thread.</li><li><strong>Lazy sweeping</strong>. Lazy sweeping involves delaying the deletion of garbage in pages until memory is required.</li></ul><p>Let us look at the major GC process:</p><ol><li>Let us assume that many minor GC cycles have passed and the old space is almost full and V8 decides to trigger a “Major GC”</li><li>Major GC recursively traverses the object graph starting from stack pointers to mark objects that are used as alive(Used memory) and remaining objects as garbage(Orphans) in the old space. This is done using multiple concurrent helper threads and each helper follows a pointer. This does not affect the main JS thread.</li><li>When concurrent marking is done or if the memory limit is reached the GC does a mark finalization step using the main thread. This introduces a small pause time.</li><li>Major GC now marks all orphan object’s memory as free using concurrent sweep threads. Parallel compaction tasks are also triggered to move related blocks of memory to the same page to avoid fragmentation. Pointers are updated during these steps.</li></ol><hr><h1 id="conclusion">Conclusion</h1><p>This post should give you an overview of the V8 memory structure and memory management. This is not exhaustive, there are a lot more advanced concepts and you can learn about them from <a href="https://v8.dev/blog/trash-talk">v8.dev</a>. But for most JS/WebAssembly developers, this level of information would be sufficient and I hope it helps you write better code, considering these in mind, for more performant applications, and keeping these in mind would help you to avoid the next memory leak issue you might encounter otherwise.</p><p>I hope you had fun learning about the V8 internals, stay tuned for the next post in the series.</p><hr><h1 id="references">References</h1><ul><li><a href="https://v8.dev/blog/trash-talk">v8.dev/blog/trash-talk</a></li><li><a href="http://jayconrod.com/posts/55/a-tour-of-v8-garbage-collection">jayconrod.com</a></li><li><a href="https://blog.codeship.com/understanding-garbage-collection-in-node-js/">blog.codeship.com</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management">developer.mozilla.org</a></li><li><a href="https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec">blog.sessionstack.com</a></li></ul><hr><p>If you like this article, please leave a like or a comment.</p><p>You can follow me on <a href="https://twitter.com/deepu105">Twitter</a> and <a href="https://www.linkedin.com/in/deepu05/">LinkedIn</a>.</p><p><em>Also published at <a href="https://dev.to/deepu105/visualizing-memory-management-in-v8-engine-javascript-nodejs-deno-webassembly-105p">Dev.to</a></em></p></div><hr><p>Post <strong>3</strong> of <strong>6</strong> in series <strong>"memory-management"</strong>.</p><p></p><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="prev d-block col-md-6" rel="prev" href="/memory-management-in-jvm/">&laquo; Prev post in series</a> <a class="prev d-block col-md-6 text-right" rel="next" href="/memory-management-in-golang/">Next post in series &raquo;</a><div class="clearfix"></div></div><div class="after-post-cats"><ul class="tags mb-4"></ul></div><div class="after-post-tags"><ul class="tags"><li><a class="smoothscroll" href="/tags#WebAssembly">#WebAssembly</a></li><li><a class="smoothscroll" href="/tags#javascript">#javascript</a></li><li><a class="smoothscroll" href="/tags#node">#node</a></li><li><a class="smoothscroll" href="/tags#typescript">#typescript</a></li></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="prev d-block col-md-6" href="/memory-management-in-jvm/">&laquo; 🚀 Visualizing memory management in JVM(Java, Kotlin, Scala, Groovy, Clojure)</a> <a class="next d-block col-md-6 text-lg-right" href="/polyglot-showdown-with-graalvm/">Polyglot inception with GraalVM. Why? Because it's fun 🏄 &raquo;</a><div class="clearfix"></div></div><hr></div></div></div><div class="container"><div id="comments" class="row justify-content-center mb-5"><div class="col-md-8"><section class="hyvor"><div id="hyvor-talk-view"></div><script type="text/javascript">var HYVOR_TALK_WEBSITE = 4123; // DO NOT CHANGE THIS
      var HYVOR_TALK_CONFIG = {
          url: 'https://deepu.tech/memory-management-in-v8/',
          id: 'https://deepu.tech/memory-management-in-v8/'
      };</script><script async type="text/javascript" src="//talk.hyvor.com/web-api/embed"></script></section></div></div></div></div><div class="alertbar"><div class="container text-center"><span>Never miss a <b>story</b> from us, subscribe to our newsletter</span><form action="https://tech.us7.list-manage.com/subscribe/post?u=00729f6c6d6bb180801b9484e&amp;id=f521dede4b" method="post" name="mc-embedded-subscribe-form" id="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate><div class="mc-field-group"><input type="email" placeholder="Email address" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"></div></form></div></div></div><div class="jumbotron fortags lozad" data-background-image="/assets/images/jumbotron.jpg"><div class="d-md-flex h-100"><div class="col-md-4 transpdark align-self-center text-center h-100"><div class="d-md-flex align-items-center justify-content-center h-100"><h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2></div></div><div class="col-md-8 pt-1 ph-2 align-self-center text-center h-100"><a class="mt-1 mb-1" href="/tags#languages">languages (14)</a> <a class="mt-1 mb-1" href="/tags#programming">programming (14)</a> <a class="mt-1 mb-1" href="/tags#javascript">javascript (12)</a> <a class="mt-1 mb-1" href="/tags#beginners">beginners (8)</a> <a class="mt-1 mb-1" href="/tags#java">java (7)</a> <a class="mt-1 mb-1" href="/tags#concurrency">concurrency (6)</a> <a class="mt-1 mb-1" href="/tags#rust">rust (6)</a> <a class="mt-1 mb-1" href="/tags#go">go (5)</a> <a class="mt-1 mb-1" href="/tags#microservices">microservices (5)</a> <a class="mt-1 mb-1" href="/tags#typescript">typescript (5)</a> <a class="mt-1 mb-1" href="/tags#computerscience">computerscience (4)</a> <a class="mt-1 mb-1" href="/tags#functional">functional (4)</a> <a class="mt-1 mb-1" href="/tags#linux">linux (4)</a> <a class="mt-1 mb-1" href="/tags#async">async (3)</a> <a class="mt-1 mb-1" href="/tags#development">development (3)</a> <a class="mt-1 mb-1" href="/tags#fedora">fedora (3)</a> <a class="mt-1 mb-1" href="/tags#jhipster">jhipster (3)</a> <a class="mt-1 mb-1" href="/tags#kubernetes">kubernetes (3)</a> <a class="mt-1 mb-1" href="/tags#thepragmaticprogrammer">thepragmaticprogrammer (3)</a> <a class="mt-1 mb-1" href="/tags#azure">azure (2)</a> <a class="mt-1 mb-1" href="/tags#career">career (2)</a> <a class="mt-1 mb-1" href="/tags#codequality">codequality (2)</a> <a class="mt-1 mb-1" href="/tags#deno">deno (2)</a> <a class="mt-1 mb-1" href="/tags#docker">docker (2)</a> <a class="mt-1 mb-1" href="/tags#garbagecollection">garbagecollection (2)</a> <a class="mt-1 mb-1" href="/tags#gnome">gnome (2)</a> <a class="mt-1 mb-1" href="/tags#node">node (2)</a> <a class="mt-1 mb-1" href="/tags#nodejs">nodejs (2)</a> <a class="mt-1 mb-1" href="/tags#react">react (2)</a> <a class="mt-1 mb-1" href="/tags#showdev">showdev (2)</a> <a class="mt-1 mb-1" href="/tags#webdev">webdev (2)</a> <a class="mt-1 mb-1" href="/tags#architecture">architecture (1)</a> <a class="mt-1 mb-1" href="/tags#bash">bash (1)</a> <a class="mt-1 mb-1" href="/tags#blogging">blogging (1)</a> <a class="mt-1 mb-1" href="/tags#books">books (1)</a> <a class="mt-1 mb-1" href="/tags#clojure">clojure (1)</a> <a class="mt-1 mb-1" href="/tags#codenewbie">codenewbie (1)</a> <a class="mt-1 mb-1" href="/tags#desktop">desktop (1)</a> <a class="mt-1 mb-1" href="/tags#devops">devops (1)</a> <a class="mt-1 mb-1" href="/tags#discuss">discuss (1)</a> <a class="mt-1 mb-1" href="/tags#distributedsystems">distributedsystems (1)</a> <a class="mt-1 mb-1" href="/tags#gaming">gaming (1)</a> <a class="mt-1 mb-1" href="/tags#golang">golang (1)</a> <a class="mt-1 mb-1" href="/tags#ide">ide (1)</a> <a class="mt-1 mb-1" href="/tags#interview">interview (1)</a> <a class="mt-1 mb-1" href="/tags#istio">istio (1)</a> <a class="mt-1 mb-1" href="/tags#Jekyll">Jekyll (1)</a> <a class="mt-1 mb-1" href="/tags#jvm">jvm (1)</a> <a class="mt-1 mb-1" href="/tags#kde">kde (1)</a> <a class="mt-1 mb-1" href="/tags#kotlin">kotlin (1)</a> <a class="mt-1 mb-1" href="/tags#medium">medium (1)</a> <a class="mt-1 mb-1" href="/tags#memory-management">memory-management (1)</a> <a class="mt-1 mb-1" href="/tags#motivation">motivation (1)</a> <a class="mt-1 mb-1" href="/tags#multithreading">multithreading (1)</a> <a class="mt-1 mb-1" href="/tags#ohmyzsh">ohmyzsh (1)</a> <a class="mt-1 mb-1" href="/tags#opensource">opensource (1)</a> <a class="mt-1 mb-1" href="/tags#polyglot">polyglot (1)</a> <a class="mt-1 mb-1" href="/tags#pragmatic">pragmatic (1)</a> <a class="mt-1 mb-1" href="/tags#python">python (1)</a> <a class="mt-1 mb-1" href="/tags#ruby">ruby (1)</a> <a class="mt-1 mb-1" href="/tags#scala">scala (1)</a> <a class="mt-1 mb-1" href="/tags#svelte">svelte (1)</a> <a class="mt-1 mb-1" href="/tags#tech">tech (1)</a> <a class="mt-1 mb-1" href="/tags#terminal">terminal (1)</a> <a class="mt-1 mb-1" href="/tags#terraform">terraform (1)</a> <a class="mt-1 mb-1" href="/tags#ubuntu">ubuntu (1)</a> <a class="mt-1 mb-1" href="/tags#v8">v8 (1)</a> <a class="mt-1 mb-1" href="/tags#vr">vr (1)</a> <a class="mt-1 mb-1" href="/tags#vscode">vscode (1)</a> <a class="mt-1 mb-1" href="/tags#web">web (1)</a> <a class="mt-1 mb-1" href="/tags#WebAssembly">WebAssembly (1)</a> <a class="mt-1 mb-1" href="/tags#webassembly">webassembly (1)</a> <a class="mt-1 mb-1" href="/tags#windows">windows (1)</a> <a class="mt-1 mb-1" href="/tags#womenintech">womenintech (1)</a> <a class="mt-1 mb-1" href="/tags#writing">writing (1)</a> <a class="mt-1 mb-1" href="/tags#zsh">zsh (1)</a></div></div></div><footer class="footer"><div class="container"><div class="row"><div class="col-md-6 col-sm-6 text-center text-lg-left">Copyright © 2021 Deepu K Sasidharan<br><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img class="lozad" alt="Creative Commons License" style="border-width:0" src="/assets/images/placeholder.jpg" data-src="https://i.creativecommons.org/l/by/4.0/88x31.png"> </a>Content licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net | Domain by <a href="https://js.org" target="_blank" title="JS.ORG | JavaScript Community"><img src="/assets/images/placeholder.jpg" data-src="https://logo.js.org/dark_tiny.png" style="width:50px" alt="JS.ORG Logo" class="lozad"> </a>| Hosted with <i class="far fa-heart"></i> by <a href="https://pages.github.com/" target="_blank">Github</a></div></div></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha256-WqU1JavFxSAMcLP2WIOI+GB2zWmShMI82mTpLDcqFUg=" crossorigin="anonymous"></script><script async src="/assets/js/mediumish.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.14.0/lozad.min.js" integrity="sha256-hstwhDmGVwZjIwt6SlTG6sQBREWrWTBjVTik/JLlb1Y=" crossorigin="anonymous"></script><script>// lazy loads images
        const lazyloadObserver = lozad()
        lazyloadObserver.observe();</script><script async src="/assets/js/ie10-viewport-bug-workaround.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74370272-6"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-74370272-6');</script></body></html>