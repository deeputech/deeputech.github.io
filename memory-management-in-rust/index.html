<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel="icon" href="/assets/images/logo.png"><title>üöÄ Visualizing memory management in Rust | Technorage</title><meta name="generator" content="Jekyll v4.1.1"><meta property="og:title" content="üöÄ Visualizing memory management in Rust"><meta name="author" content="deepu"><meta property="og:locale" content="en_US"><meta name="description" content="Let us take a closer look at how Rust manages memory."><meta property="og:description" content="Let us take a closer look at how Rust manages memory."><link rel="canonical" href="https://deepu.tech/memory-management-in-rust/"><meta property="og:url" content="https://deepu.tech/memory-management-in-rust/"><meta property="og:site_name" content="Technorage"><meta property="og:type" content="article"><meta property="article:published_time" content="2020-03-31T00:00:00+02:00"><meta name="twitter:card" content="summary"><meta property="twitter:title" content="üöÄ Visualizing memory management in Rust"><script type="application/ld+json">{"author":{"@type":"Person","name":"deepu"},"description":"Let us take a closer look at how Rust manages memory.","headline":"üöÄ Visualizing memory management in Rust","dateModified":"2020-03-31T00:00:00+02:00","datePublished":"2020-03-31T00:00:00+02:00","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://deepu.tech/assets/images/logo.png"},"name":"deepu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://deepu.tech/memory-management-in-rust/"},"url":"https://deepu.tech/memory-management-in-rust/","@context":"https://schema.org"}</script><link rel="canonical" href="https://deepu.tech/memory-management-in-rust/"><meta property="og:url" content=""><meta name="monetization" content="$ilp.uphold.com/Aw7eGpxKNyK7"><meta name="twitter:site" content="@deepu105"><meta name="twitter:creator" content="@deepu105"><meta name="twitter:title" content="üöÄ Visualizing memory management in Rust"><meta name="twitter:description" content="Let us take a closer look at how Rust manages memory."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://i.imgur.com/xolsOsW.jpg"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha256-L/W5Wfqfa0sdBNIKN9cG6QA5F2qx4qICmU2VgLruv9Y=" crossorigin="anonymous"><link href="/assets/css/screen.css" rel="stylesheet"><link href="/assets/css/main.css" rel="stylesheet"></head><body class="layout-post"><noscript id="deferred-styles"><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" crossorigin="anonymous"></noscript><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down pr-md-0 pl-md-0"><div class="container d-flex align-items-center"><a class="navbar-brand" href="/"><h2>Deepu K Sasidharan</h2></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarMediumish"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" href="/">About</a></li><li class="nav-item active"><a class="nav-link" href="/blogs/"><i class="fas fa-blog"></i> Blog</a></li><li class="nav-item"><a class="nav-link" href="/books"><i class="fas fa-book"></i> Books</a></li><li class="nav-item"><a target="_blank" class="nav-link" href="https://www.youtube.com/playlist?list=PLxayiD7e52nPpb-sSaoOPc-zXGhmOaNHK"><i class="fab fa-youtube"></i> Videos</a></li><li class="nav-item"><a target="_blank" class="nav-link" href="https://speakerdeck.com/deepu105"><i class="fab fa-speaker-deck"></i> Presentations</a></li><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.slim.min.js" integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.8/lunr.min.js" integrity="sha256-34Si1Y6llMBKM3G0jQILVeoQKEwuxjbk4zGWXXMT4ps=" crossorigin="anonymous"></script><style>.lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}</style><form class="bd-search" onsubmit="return lunr_search(document.getElementById('lunrsearch').value);"><input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."></form><div id="lunrsearchresults"><ul></ul></div><script src="/assets/js/lunrsearchengine.js"></script></ul></div></div></nav><div class="site-content"><div class="container"><div class="main-content"><div class="mainheading"><h1 class="sitetitle">Technorage</h1><p class="lead">Where I rage about technology and stuff!</p></div><div class="container"><div class="row"><div class="col-lg-2 pl-0"><div class="sticky-top sticky-top-offset"><div class="popover-wrapper d-none d-lg-block"><a href="#"><h2 class="popover-title"><i class="fas fa-stream fa-lg"></i> TOC</h2></a><div class="popover-content"><div class="toc lead"><h3 class="font-weight-bold">Summary</h3><ul><li><a href="#rust-internal-memory-structure">Rust internal memory structure</a><ul><li><a href="#heap">Heap</a></li><li><a href="#stack">Stack</a></li></ul></li><li><a href="#rust-memory-usage-stack-vs-heap">Rust memory usage (Stack vs Heap)</a></li><li><a href="#rust-memory-management-ownership">Rust Memory management: Ownership</a><ul><li><a href="#raii">RAII</a></li><li><a href="#borrowing--borrow-checker">Borrowing &amp; Borrow checker</a></li><li><a href="#variable-lifetimes">Variable Lifetimes</a></li><li><a href="#smart-pointers">Smart pointers</a></li></ul></li><li><a href="#ownership-visualization">Ownership visualization</a></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#references">References</a></li></ul></div></div></div><div class="share"><p>Share</p><ul><li class="ml-1 mr-1"><a target="_blank" href="https://twitter.com/intent/tweet?text=üöÄ Visualizing memory management in Rust by @deepu105 &url=https://deepu.tech/memory-management-in-rust/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://deepu.tech/memory-management-in-rust/" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=435');return false;" title="Linkedin"><i class="fab fa-linkedin-in"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://news.ycombinator.com/submitlink?u=https://deepu.tech/memory-management-in-rust/&t=üöÄ Visualizing memory management in Rust" onclick="window.open(this.href, 'hackernews-share', 'width=550,height=435');return false;" title="Hacker News"><i class="fab fa-hacker-news-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.reddit.com/submit?url=https://deepu.tech/memory-management-in-rust/&title=üöÄ Visualizing memory management in Rust" onclick="window.open(this.href, 'reddit-share', 'width=550,height=435');return false;" title="Reddit"><i class="fab fa-reddit-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://facebook.com/sharer.php?u=https://deepu.tech/memory-management-in-rust/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;" title="Facebook"><i class="fab fa-facebook-f"></i></a></li></ul><div class="sep"></div><ul><li><a class="small smoothscroll" href="#disqus_thread"></a></li></ul></div><div class="ad-vertical-md"><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7ITK3I&placement=deeputech" id="_carbonads_js"></script></div></div></div><div class="col-lg-9 flex-first flex-lg-unordered"><div class="mainheading"><h1 class="posttitle">üöÄ Visualizing memory management in Rust</h1><img data-src="https://i.imgur.com/xolsOsW.jpg" alt="üöÄ Visualizing memory management in Rust" class="featured-image img-fluid lozad" src="/assets/images/placeholder.jpg"><div class="row post-top-meta"><div class="col-12 text-center text-md-left mb-4 mb-md-0"><img class="author-thumb lozad" src="/assets/images/placeholder.jpg" data-src="https://www.gravatar.com/avatar/7f408bc67dc9ae3b288ee92d16d3c4c2?s=250&d=mm&r=x" alt="Deepu K Sasidharan"> <a target="_blank" class="link-dark" href="https://www.deepu.tech">Deepu K Sasidharan</a><a target="_blank" href="https://twitter.com/deepu105" class="btn follow">Follow</a><span class="separator d-none d-md-inline-block">| </span><span class="author-description"><small><time class="post-date" datetime="2020-03-31">31 Mar 2020</time> </small><span class="separator d-inline-block">| </span><small>16 mins read</small> <span class="separator d-inline-block d-lg-none">| </span><span class="d-inline-block d-lg-none"><div class="share" style="margin-top: 0;"><ul><li class="ml-1 mr-1"><a target="_blank" href="https://twitter.com/intent/tweet?text=üöÄ Visualizing memory management in Rust by @deepu105 &url=https://deepu.tech/memory-management-in-rust/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://deepu.tech/memory-management-in-rust/" onclick="window.open(this.href, 'linkedin-share', 'width=550,height=435');return false;" title="Linkedin"><i class="fab fa-linkedin-in"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://news.ycombinator.com/submitlink?u=https://deepu.tech/memory-management-in-rust/&t=üöÄ Visualizing memory management in Rust" onclick="window.open(this.href, 'hackernews-share', 'width=550,height=435');return false;" title="Hacker News"><i class="fab fa-hacker-news-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://www.reddit.com/submit?url=https://deepu.tech/memory-management-in-rust/&title=üöÄ Visualizing memory management in Rust" onclick="window.open(this.href, 'reddit-share', 'width=550,height=435');return false;" title="Reddit"><i class="fab fa-reddit-square"></i></a></li><li class="ml-1 mr-1"><a target="_blank" href="https://facebook.com/sharer.php?u=https://deepu.tech/memory-management-in-rust/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;" title="Facebook"><i class="fab fa-facebook-f"></i></a></li></ul></div></span></span></div></div></div><div class="panel series-wrapper"><p><strong>Part of "memory-management" series</strong></p><div class="article-collection"><a href="/memory-management-in-programming/" title="Part 1: üöÄ Demystifying memory management in modern programming languages"></a> <a href="/memory-management-in-jvm/" title="Part 2: üöÄ Visualizing memory management in JVM(Java, Kotlin, Scala, Groovy, Clojure)"></a> <a href="/memory-management-in-v8/" title="Part 3: üöÄ Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)"></a> <a href="/memory-management-in-golang/" title="Part 4: üöÄ Visualizing memory management in Golang"></a> <a href="/memory-management-in-rust/" title="Part 5: üöÄ Visualizing memory management in Rust" class="current-article"></a> <a href="/avoiding-memory-leaks-in-nodejs/" title="Part 6: Avoiding Memory Leaks in NodeJS: Best Practices for Performance"></a></div></div><div class="article-post"><p>Please follow me on <a href="https://twitter.com/deepu105">Twitter</a> for updates and let me know if something can be improved in the post.</p><hr><p>In this multi-part series, I aim to demystify the concepts behind memory management and take a deeper look at memory management in some of the modern programming languages. I hope the series would give you some insights into what is happening under the hood of these languages in terms of memory management.</p><p>In this chapter, we will look at the memory management of the <strong><a href="https://www.rust-lang.org/">Rust</a></strong> programming language. Rust is a statically typed &amp; compiled systems programming language like C &amp; C++. Rust is memory &amp; thread-safe and does not have a runtime or a garbage collector. I previously also wrote about <a href="https://deepu.tech/first-impression-of-rust/">my first impressions of Rust</a>.</p><p>If you haven‚Äôt read the <a href="https://deepu.tech/memory-management-in-programming/">first part</a> of this series, please read it first as I explained the difference between the Stack and Heap memory there which would be useful to understand this chapter.</p><blockquote><p>This post is based on Rust 1.41 official implementation and concept details might change in the future versions of Rust</p></blockquote><p>Compared to other languages we saw until now in this series, Rust is quite unique let us see how.</p><h1 id="rust-internal-memory-structure">Rust internal memory structure</h1><p>First, let us take a look at the internal memory structure of Rust.</p><p>Rust doesn‚Äôt have a defined <a href="https://doc.rust-lang.org/beta/reference/memory-model.html">memory model</a> in the language specifications as of now and the memory structure is quite straightforward.</p><p>Each Rust program process is allocated some virtual memory by the Operating System(OS), this is the total memory that the process has access to.</p><p><img src="https://i.imgur.com/mUOasWj.png" alt="Rust Memory structure"></p><p>This is quite simple compared to the memory structure we saw in the previous chapters for <a href="https://deepu.tech/memory-management-in-jvm/">JVM</a>, <a href="https://deepu.tech/memory-management-in-v8/">V8</a> and <a href="https://deepu.tech/memory-management-in-golang/">Go</a>. As you can see there is no generational memory or any complex substructures since Garbage Collection(GC) is not involved. The reason for this is that Rust manages memory as part of program execution during runtime using the Ownership model rather than using any kind of GC.</p><p>Let us see what the different memory are:</p><h2 id="heap">Heap</h2><p>This is where all dynamic data(any data for which size cannot be calculated at compile time) is stored. This is the biggest block of memory and the part managed by Rust‚Äôs Ownership model.</p><ul><li><strong>Box</strong>: The <a href="https://doc.rust-lang.org/stable/rust-by-example/std/box.html"><code class="language-plaintext highlighter-rouge">Box</code></a> type is an abstraction for a heap-allocated value in Rust. Heap memory is allocated when <code class="language-plaintext highlighter-rouge">Box::new</code> is called. A <code class="language-plaintext highlighter-rouge">Box&lt;T&gt;</code> holds the smart-pointer to the heap memory allocated for type <code class="language-plaintext highlighter-rouge">T</code> and the reference is saved on the Stack.</li></ul><h2 id="stack">Stack</h2><p>This is the Stack memory area and there is one Stack per thread. This is where static values are allocated by default. Static data(data size known at compile time) includes function frames, primitive values, Structs and pointers to dynamic data in Heap.</p><hr><h1 id="rust-memory-usage-stack-vs-heap">Rust memory usage (Stack vs Heap)</h1><p>Now that we are clear about how memory is organized let‚Äôs see how Rust uses Stack and Heap when a program is executed.</p><p>Let‚Äôs use the below Rust program, the code is not optimized for correctness hence ignore issues like unnecessary intermediatory variables and such, the focus is to visualize Stack and Heap memory usage.</p><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">Employee</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c">// The 'a defines the lifetime of the struct. Here it means the reference of `name` field must outlive the `Employee`</span>
    <span class="n">name</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">salary</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span>
    <span class="n">sales</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span>
    <span class="n">bonus</span><span class="p">:</span> <span class="nb">i32</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">BONUS_PERCENTAGE</span><span class="p">:</span> <span class="nb">i32</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="c">// salary is borrowed</span>
<span class="k">fn</span> <span class="nf">get_bonus_percentage</span><span class="p">(</span><span class="n">salary</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">salary</span> <span class="o">*</span> <span class="n">BONUS_PERCENTAGE</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">percentage</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">// salary is borrowed while no_of_sales is copied</span>
<span class="k">fn</span> <span class="nf">find_employee_bonus</span><span class="p">(</span><span class="n">salary</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">i32</span><span class="p">,</span> <span class="n">no_of_sales</span><span class="p">:</span> <span class="nb">i32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">bonus_percentage</span> <span class="o">=</span> <span class="nf">get_bonus_percentage</span><span class="p">(</span><span class="n">salary</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">bonus</span> <span class="o">=</span> <span class="n">bonus_percentage</span> <span class="o">*</span> <span class="n">no_of_sales</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">bonus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// variable is declared as mutable</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">john</span> <span class="o">=</span> <span class="n">Employee</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="s">"John"</span><span class="p">),</span> <span class="c">// explicitly making the value dynamic</span>
        <span class="n">salary</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
        <span class="n">sales</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">bonus</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c">// salary is borrowed while sales is copied since i32 is a primitive</span>
    <span class="n">john</span><span class="py">.bonus</span> <span class="o">=</span> <span class="nf">find_employee_bonus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">john</span><span class="py">.salary</span><span class="p">,</span> <span class="n">john</span><span class="py">.sales</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Bonus for {} is {}"</span><span class="p">,</span> <span class="n">john</span><span class="py">.name</span><span class="p">,</span> <span class="n">john</span><span class="py">.bonus</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>All values in Rust are allocated on the Stack by default. There are two exceptions to this:</p><ol><li>When the size of the value is unknown, i.e Structs like String which grows in size over time or any other dynamic value</li><li>When you manually create a <code class="language-plaintext highlighter-rouge">Box&lt;T&gt;</code> value like <code class="language-plaintext highlighter-rouge">Box::new("Hello")</code>. A box is a smart pointer to a heap-allocated value of type T. When a box goes out of scope, its destructor is called, the inner object is destroyed, and the memory on the Heap is freed.</li></ol><p>In both exception cases, the value will be allocated on Heap and its pointer will live on the Stack.</p><p>Let us visualize this. Click on the slides and move forward/backward using arrow keys to see how the above program is executed and how the Stack and Heap memory is used:</p><p><script async="" class="speakerdeck-embed" data-id="760299e421d649f985d5b04952dcc4f2" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script><noscript><a href="//speakerdeck.com/player/760299e421d649f985d5b04952dcc4f2"><img alt="Speakerdeck" class="lozad" src="{{ site.baseurl }}/assets/images/placeholder.jpg" data-src="//speakerd.s3.amazonaws.com/presentations/760299e421d649f985d5b04952dcc4f2/slide_0.jpg"></a></noscript></p><p><em>Note: If the slides look cut off at edges, then click on the title of the slide or <a href="https://speakerdeck.com/deepu105/rust-stack-vs-heap-usage">here</a> to open it directly in SpeakerDeck.</em></p><p>As you can see:</p><ul><li><strong>Main</strong> function is kept in a ‚Äúmain frame‚Äù on the Stack</li><li>Every function call is added to the Stack memory as a frame-block</li><li>All static variables including arguments and the return value is saved within the function frame-block on the Stack</li><li>All static values regardless of type are stored directly on the Stack. This applies to global scope as well</li><li>All dynamic types created on the Heap and is referenced from the Stack using smart pointers. This applies to the global scope as well. Here we explicitly made the name dynamic to avoid it going to the Stack as having a fixed-length string value will do that</li><li>The struct with static data is kept on the Stack and any dynamic value in it is kept on the Heap and is referenced via pointers</li><li>Functions called from the current function is pushed on top of the Stack</li><li>When a function returns its frame is removed from the Stack</li><li>Unlike Garbage collected languages, once the main process is complete, the objects on the Heap are destroyed as well, we will see more about this in the following sections</li></ul><p>The Stack as you can see is automatically managed and is done so by the operating system rather than Rust itself. Hence we do not have to worry much about the Stack. The Heap, on the other hand, is not automatically managed by the OS and since its the biggest memory space and holds dynamic data, it could grow exponentially causing our program to run out of memory over time. It also becomes fragmented over time slowing down applications. This is where Rust‚Äôs ownership model steps in to automatically manage the Heap memory</p><p><em>Note: you can find the code I used to identify where a value ends up <a href="https://gist.github.com/deepu105/3e49702d6ffac025eb8b8ca9539d7f67">here</a></em></p><hr><h1 id="rust-memory-management-ownership">Rust Memory management: Ownership</h1><p>Rust has one of the most unique ways of managing Heap memory and that is what makes Rust special. It uses a concept called <a href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html">ownership</a> to manage memory. It is defined by a set of rules</p><ol><li>Every value in Rust must have a variable as its owner</li><li>There must be only one owner for a variable at any given time</li><li>When the owner goes out of scope the value will be dropped freeing the memory</li></ol><p>The rules are applicable regardless of the value being in Stack or Heap memory. For example, in the below example the value of <code class="language-plaintext highlighter-rouge">foo</code> is dropped as soon as the method execution completes and the value of <code class="language-plaintext highlighter-rouge">bar</code> is dropped right after the block execution.</p><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">foo</span> <span class="o">=</span> <span class="s">"value"</span><span class="p">;</span> <span class="c">// owner is foo and is valid within this method</span>
    <span class="c">// bar is not valid here as its not declared yet</span>

    <span class="p">{</span>
        <span class="k">let</span> <span class="n">bar</span> <span class="o">=</span> <span class="s">"bar value"</span><span class="p">;</span> <span class="c">// owner is bar and is valid within this block scope</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"value of bar is {}"</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span> <span class="c">// bar is valid here</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"value of foo is {}"</span><span class="p">,</span> <span class="n">foo</span><span class="p">);</span> <span class="c">// foo is valid here</span>
    <span class="p">}</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"value of foo is {}"</span><span class="p">,</span> <span class="n">foo</span><span class="p">);</span> <span class="c">// foo is valid here</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"value of bar is {}"</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span> <span class="c">// bar is not valid here as its out of scope</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><p>These rules are checked by the compiler at compile-time and the freeing of memory happens at runtime along with program execution and hence there is no additional overhead or pause times here. So by scoping variables carefully, we can make sure the memory usage is optimized and that is also why Rust lets you use block scope almost everywhere. This might sound simple but in practice, this concept has deep implications in how you write Rust programs and it takes some getting used to. The Rust compiler does a great job of helping you along the way as well.</p><p>Due to the strict ownership rules, Rust lets you change the ownership from one variable to another and is called a <code class="language-plaintext highlighter-rouge">move</code>. This is automatically done when passing a variable into a function or when creating a new assignment. For static primitives, a copy is used instead of move.</p><p>There are a few more concepts related to memory management that play along with Ownership to make it effective</p><h2 id="raii">RAII</h2><p><a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII</a> stands for Resource acquisition is initialization. This is not new in Rust, this is borrowed from C++. Rust enforces RAII so that when a value is initialized the variable owns the resources associated and its destructor is called when the variable goes out of scope freeing the resources. This ensures that we will never have to manually free memory or worry about memory leaks. Here is an example</p><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">create_box</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// Allocate a string on the heap</span>
    <span class="k">let</span> <span class="mi">_</span><span class="n">var_i</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nd">format!</span><span class="p">(</span><span class="s">"Hello {}"</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="c">// `_var_i` is destroyed here, and memory gets freed</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Allocate an integer on the heap</span>
    <span class="k">let</span> <span class="mi">_</span><span class="n">var_1</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">5u32</span><span class="p">);</span>
    <span class="c">// A nested scope:</span>
    <span class="p">{</span>
        <span class="c">// Allocate a string on the heap</span>
        <span class="k">let</span> <span class="mi">_</span><span class="n">var_2</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"Hello 2"</span><span class="p">);</span>
        <span class="c">// `_var_2` is destroyed here, and memory gets freed</span>
    <span class="p">}</span>

    <span class="c">// Creating lots of boxes</span>
    <span class="c">// There's no need to manually free memory!</span>
    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="mi">0u32</span><span class="o">..</span><span class="mi">1_000</span> <span class="p">{</span>
        <span class="nf">create_box</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c">// `_var_1` is destroyed here, and memory gets freed</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h2 id="borrowing--borrow-checker">Borrowing &amp; Borrow checker</h2><p>In Rust we can pass a variable by either value or by reference and passing a variable by reference is called borrowing. Since we can have only one owner for a resource at a time, we have to borrow a resource to use it without taking ownership of it. Rust compiler has a borrow checker that statically ensures that references point to valid objects and ownership rules are not violated. Here is a simplified version of the Rust official example.</p><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="c">// This function takes ownership of the passed value</span>
<span class="k">fn</span> <span class="nf">take_ownership</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="nb">i32</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Destroying box that contains {}"</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="c">// This function borrows the value by reference</span>
<span class="k">fn</span> <span class="nf">borrow</span><span class="p">(</span><span class="n">reference</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">i32</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"This is: {}"</span><span class="p">,</span> <span class="n">reference</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Create a boxed and a stacked variable</span>
    <span class="k">let</span> <span class="n">boxed</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">5_i32</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">stacked</span> <span class="o">=</span> <span class="mi">6_i32</span><span class="p">;</span>

    <span class="c">// Borrow the contents of the box. Ownership is not taken,</span>
    <span class="c">// so the contents can be borrowed again.</span>
    <span class="nf">borrow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boxed</span><span class="p">);</span>
    <span class="nf">borrow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stacked</span><span class="p">);</span>

    <span class="p">{</span>
        <span class="c">// Take a reference to the data contained inside the box</span>
        <span class="k">let</span> <span class="mi">_</span><span class="n">ref_to_boxed</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">i32</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">boxed</span><span class="p">;</span>

        <span class="c">// Error!</span>
        <span class="c">// Can't destroy `boxed` while the inner value is borrowed later in scope.</span>
        <span class="nf">take_ownership</span><span class="p">(</span><span class="n">boxed</span><span class="p">);</span>

        <span class="c">// Attempt to borrow `_ref_to_boxed` after inner value is destroyed</span>
        <span class="nf">borrow</span><span class="p">(</span><span class="mi">_</span><span class="n">ref_to_boxed</span><span class="p">);</span>
        <span class="c">// `_ref_to_boxed` goes out of scope and is no longer borrowed.</span>
    <span class="p">}</span>

    <span class="c">// `boxed` can now give up ownership to `take_ownership` method and be destroyed</span>
    <span class="nf">take_ownership</span><span class="p">(</span><span class="n">boxed</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div><h2 id="variable-lifetimes">Variable Lifetimes</h2><p>The lifetime of variables is another very important concept to make the ownership model work. It is a construct used by the borrow checker in order to ensure that all references to an object is valid. This is checked during compile time. The lifetime of a variable begins when its initialized and ends when it is destroyed. Lifetime is not the same as the scope.</p><p>This might sound straight forward but lifetimes get much more complex once functions and structs with references come into play and once they do then we would need to start using <a href="https://doc.rust-lang.org/stable/rust-by-example/scope/lifetime/explicit.html">lifetime annotations</a> to let the borrow checker know how long references are valid. Sometimes the compiler can <a href="https://doc.rust-lang.org/stable/rust-by-example/scope/lifetime/elision.html">infer lifetimes</a>, but not always. I‚Äôm not going to details here as its not in the scope of this article</p><h2 id="smart-pointers">Smart pointers</h2><p>Pointers are nothing but a reference to a memory address on the Heap. Rust has support for pointers and lets us reference and dereference them using <code class="language-plaintext highlighter-rouge">&amp;</code> and <code class="language-plaintext highlighter-rouge">*</code> operators. <a href="https://doc.rust-lang.org/book/ch15-00-smart-pointers.html?highlight=smart#smart-pointers">Smart pointers</a> in Rust are like pointers but with additional metadata capabilities. Like RAII this is another concept taken from C++. Unlike pointers which are references that only borrow data, smart pointers own the data they point to. <code class="language-plaintext highlighter-rouge">Box</code>, <code class="language-plaintext highlighter-rouge">String</code> and <code class="language-plaintext highlighter-rouge">Vec</code> are examples of smart pointers in Rust. You can also write your own smart pointers using structs.</p><h1 id="ownership-visualization">Ownership visualization</h1><p>Now that we have seen different concepts used for Ownership, let us visualize it, unlike other languages where we visualized the data in Heap, here it is much easier if we look at the <a href="https://gist.github.com/deepu105/681462673576bea16802c74252867323">code itself</a>.</p><p><img src="https://i.imgur.com/mVIAoZg.jpg" alt="Lifetime of variables"></p><hr><h1 id="conclusion">Conclusion</h1><p>This post should give you an overview of the Rust memory structure and memory management. This is not exhaustive, there are a lot more advanced concepts and the implementation details keep changing from version to version. Unlike Garbage collected languages, where you need not understand the memory management model to use the language, in Rust, it is required to understand how Ownership works in order to write programs. This post is just a starting step, I recommend that you dive into the Rust documentation to learn more about these concepts.</p><p>I hope you had fun learning this, stay tuned for the next post in the series.</p><hr><h1 id="references">References</h1><ul><li><a href="https://doc.rust-lang.org">doc.rust-lang.org</a></li><li><a href="https://www.youtube.com/watch?v=2IxQgXQl_Ws">www.youtube.com</a></li><li><a href="https://pcwalton.github.io/2013/03/18/an-overview-of-memory-management-in-rust.html">pcwalton.github.io</a></li><li><a href="http://zee-nix.blogspot.com/2017/05/rust-memory-management.html">zee-nix.blogspot.com</a></li><li><a href="https://hacks.mozilla.org/2019/01/fearless-security-memory-safety/">hacks.mozilla.org</a></li><li><a href="https://os.phil-opp.com/heap-allocation/">os.phil-opp.com/heap-allocation</a></li><li><a href="https://msrc-blog.microsoft.com/2019/07/22/why-rust-for-safe-systems-programming/">msrc-blog.microsoft.com</a></li></ul><hr><p>If you like this article, please leave a like or a comment.</p><p>You can follow me on <a href="https://twitter.com/deepu105">Twitter</a> and <a href="https://www.linkedin.com/in/deepu05/">LinkedIn</a>.</p><p>Cover image inspired by <a href="https://hacks.mozilla.org/2019/01/fearless-security-memory-safety/">https://hacks.mozilla.org/2019/01/fearless-security-memory-safety/</a></p><hr><p><em>Also published at <a href="https://dev.to/deepu105/visualizing-memory-management-in-rust-5898">Dev.to</a></em></p></div><div class="after-post-cats"><ul class="tags mb-4"></ul></div><div class="after-post-tags"><ul class="tags"><li><a class="smoothscroll" href="/tags#computerscience">#computerscience</a></li><li><a class="smoothscroll" href="/tags#garbagecollection">#garbagecollection</a></li><li><a class="smoothscroll" href="/tags#programming">#programming</a></li><li><a class="smoothscroll" href="/tags#rust">#rust</a></li></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="prev d-block col-md-6" href="/deno-runtime-for-typescript/">&laquo; Forget NodeJS! Build native TypeScript applications with Deno ü¶ñ</a> <a class="next d-block col-md-6 text-lg-right" href="/avoiding-memory-leaks-in-nodejs/">Avoiding Memory Leaks in NodeJS: Best Practices for Performance &raquo;</a><div class="clearfix"></div></div></div></div></div><div class="container"><div id="comments" class="row justify-content-center mb-5"><div class="col-md-8"><section class="disqus"><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'deepu-tech'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></div></div></div></div><div class="alertbar"><div class="container text-center"><span>Never miss a <b>story</b> from us, subscribe to our newsletter</span><form action="https://tech.us7.list-manage.com/subscribe/post?u=00729f6c6d6bb180801b9484e&amp;id=f521dede4b" method="post" name="mc-embedded-subscribe-form" id="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate><div class="mc-field-group"><input type="email" placeholder="Email address" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"></div></form></div></div></div><div class="jumbotron fortags lozad" data-background-image="/assets/images/jumbotron.jpg"><div class="d-md-flex h-100"><div class="col-md-4 transpdark align-self-center text-center h-100"><div class="d-md-flex align-items-center justify-content-center h-100"><h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">‚Üí</span></h2></div></div><div class="col-md-8 p-5 align-self-center text-center"><a class="mt-1 mb-1" href="/tags#jhipster">jhipster (3)</a> <a class="mt-1 mb-1" href="/tags#java">java (6)</a> <a class="mt-1 mb-1" href="/tags#microservices">microservices (5)</a> <a class="mt-1 mb-1" href="/tags#docker">docker (2)</a> <a class="mt-1 mb-1" href="/tags#azure">azure (2)</a> <a class="mt-1 mb-1" href="/tags#kubernetes">kubernetes (3)</a> <a class="mt-1 mb-1" href="/tags#typescript">typescript (4)</a> <a class="mt-1 mb-1" href="/tags#react">react (1)</a> <a class="mt-1 mb-1" href="/tags#javascript">javascript (10)</a> <a class="mt-1 mb-1" href="/tags#webdev">webdev (2)</a> <a class="mt-1 mb-1" href="/tags#terraform">terraform (1)</a> <a class="mt-1 mb-1" href="/tags#writing">writing (1)</a> <a class="mt-1 mb-1" href="/tags#medium">medium (1)</a> <a class="mt-1 mb-1" href="/tags#development">development (3)</a> <a class="mt-1 mb-1" href="/tags#tech">tech (1)</a> <a class="mt-1 mb-1" href="/tags#linux">linux (3)</a> <a class="mt-1 mb-1" href="/tags#fedora">fedora (2)</a> <a class="mt-1 mb-1" href="/tags#gnome">gnome (2)</a> <a class="mt-1 mb-1" href="/tags#desktop">desktop (1)</a> <a class="mt-1 mb-1" href="/tags#terminal">terminal (1)</a> <a class="mt-1 mb-1" href="/tags#ohmyzsh">ohmyzsh (1)</a> <a class="mt-1 mb-1" href="/tags#zsh">zsh (1)</a> <a class="mt-1 mb-1" href="/tags#go">go (5)</a> <a class="mt-1 mb-1" href="/tags#programming">programming (13)</a> <a class="mt-1 mb-1" href="/tags#languages">languages (12)</a> <a class="mt-1 mb-1" href="/tags#thepragmaticprogrammer">thepragmaticprogrammer (3)</a> <a class="mt-1 mb-1" href="/tags#vscode">vscode (1)</a> <a class="mt-1 mb-1" href="/tags#ide">ide (1)</a> <a class="mt-1 mb-1" href="/tags#opensource">opensource (1)</a> <a class="mt-1 mb-1" href="/tags#istio">istio (1)</a> <a class="mt-1 mb-1" href="/tags#functional">functional (4)</a> <a class="mt-1 mb-1" href="/tags#beginners">beginners (8)</a> <a class="mt-1 mb-1" href="/tags#showdev">showdev (2)</a> <a class="mt-1 mb-1" href="/tags#ruby">ruby (1)</a> <a class="mt-1 mb-1" href="/tags#Jekyll">Jekyll (1)</a> <a class="mt-1 mb-1" href="/tags#blogging">blogging (1)</a> <a class="mt-1 mb-1" href="/tags#architecture">architecture (1)</a> <a class="mt-1 mb-1" href="/tags#devops">devops (1)</a> <a class="mt-1 mb-1" href="/tags#distributedsystems">distributedsystems (1)</a> <a class="mt-1 mb-1" href="/tags#rust">rust (5)</a> <a class="mt-1 mb-1" href="/tags#bash">bash (1)</a> <a class="mt-1 mb-1" href="/tags#codenewbie">codenewbie (1)</a> <a class="mt-1 mb-1" href="/tags#codequality">codequality (2)</a> <a class="mt-1 mb-1" href="/tags#career">career (2)</a> <a class="mt-1 mb-1" href="/tags#computerscience">computerscience (4)</a> <a class="mt-1 mb-1" href="/tags#motivation">motivation (1)</a> <a class="mt-1 mb-1" href="/tags#books">books (1)</a> <a class="mt-1 mb-1" href="/tags#kotlin">kotlin (1)</a> <a class="mt-1 mb-1" href="/tags#scala">scala (1)</a> <a class="mt-1 mb-1" href="/tags#clojure">clojure (1)</a> <a class="mt-1 mb-1" href="/tags#WebAssembly">WebAssembly (1)</a> <a class="mt-1 mb-1" href="/tags#node">node (2)</a> <a class="mt-1 mb-1" href="/tags#python">python (1)</a> <a class="mt-1 mb-1" href="/tags#garbagecollection">garbagecollection (2)</a> <a class="mt-1 mb-1" href="/tags#nodejs">nodejs (2)</a> <a class="mt-1 mb-1" href="/tags#deno">deno (1)</a> <a class="mt-1 mb-1" href="/tags#v8">v8 (1)</a> <a class="mt-1 mb-1" href="/tags#memory-management">memory-management (1)</a> <a class="mt-1 mb-1" href="/tags#windows">windows (1)</a> <a class="mt-1 mb-1" href="/tags#vr">vr (1)</a> <a class="mt-1 mb-1" href="/tags#gaming">gaming (1)</a> <a class="mt-1 mb-1" href="/tags#polyglot">polyglot (1)</a> <a class="mt-1 mb-1" href="/tags#interview">interview (1)</a> <a class="mt-1 mb-1" href="/tags#womenintech">womenintech (1)</a> <a class="mt-1 mb-1" href="/tags#discuss">discuss (1)</a> <a class="mt-1 mb-1" href="/tags#pragmatic">pragmatic (1)</a> <a class="mt-1 mb-1" href="/tags#concurrency">concurrency (4)</a> <a class="mt-1 mb-1" href="/tags#async">async (3)</a> <a class="mt-1 mb-1" href="/tags#multithreading">multithreading (1)</a> <a class="mt-1 mb-1" href="/tags#golang">golang (1)</a></div></div></div><footer class="footer"><div class="container"><div class="row"><div class="col-md-6 col-sm-6 text-center text-lg-left">Copyright ¬© 2021 Deepu K Sasidharan<br><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img class="lozad" alt="Creative Commons License" style="border-width:0" src="/assets/images/placeholder.jpg" data-src="https://i.creativecommons.org/l/by/4.0/88x31.png"> </a>Content licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net | Domain by <a href="https://js.org" target="_blank" title="JS.ORG | JavaScript Community"><img src="/assets/images/placeholder.jpg" data-src="https://logo.js.org/dark_tiny.png" style="width:50px" alt="JS.ORG Logo" class="lozad"> </a>| Hosted with <i class="far fa-heart"></i> by <a href="https://pages.github.com/" target="_blank">Github</a></div></div></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha256-WqU1JavFxSAMcLP2WIOI+GB2zWmShMI82mTpLDcqFUg=" crossorigin="anonymous"></script><script async src="/assets/js/mediumish.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.14.0/lozad.min.js" integrity="sha256-hstwhDmGVwZjIwt6SlTG6sQBREWrWTBjVTik/JLlb1Y=" crossorigin="anonymous"></script><script>// lazy loads images
        const lazyloadObserver = lozad()
        lazyloadObserver.observe();</script><script async src="/assets/js/ie10-viewport-bug-workaround.js"></script><script async id="dsq-count-scr" src="//deepu-tech.disqus.com/count.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74370272-6"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-74370272-6');</script></body></html>